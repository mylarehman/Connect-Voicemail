{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/repo/users-repo.js","webpack:///./src/service/global-settings.services.js","webpack:///./src/domain/connect-agent.domain.js","webpack:///./src/errors/agent.errors.js","webpack:///./src/service/connect-agent.service.js","webpack:///./src/handler/transcription.js","webpack:///./src/domain/connect-user.domain.js","webpack:///./src/service/connect.service.js","webpack:///./src/domain/global-settings.domain.js","webpack:///./src/repo/global-repo.js","webpack:///./src/errors/standard.errors.js","webpack:///./src/repo/voicemail.repo.js","webpack:///./src/service/notification.service.js","webpack:///external \"nodemailer\"","webpack:///./src/service/s3.service.js","webpack:///./src/service/transcription.service.js","webpack:///external \"request-promise\"","webpack:///./src/domain/voicemail.domain.js","webpack:///./src/service/voicemail.service.js","webpack:///external \"aws-sdk\"","webpack:///./src/lib/dynamo.js","webpack:///./src/domain/agent.domain.js","webpack:///external \"awesome-phonenumber\""],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","UsersRepo","this","dynamo","process","env","USERS_TABLE_NAME","amazonConnectInstanceId","AMAZON_CONNECT_INSTANCE_ARN","extension","params","IndexName","KeyConditionExpression","ExpressionAttributeValues","query","then","items","length","userId","Key","agentId","getItem","item","next","size","param","Limit","Select","ExclusiveStartKey","JSON","parse","Buffer","from","toString","scanWithNext","scan","agent","data","Item","createAgentData","put","deliverSMSPhoneNumber","deliverSMS","deliverEmail","encryptVoicemail","transcribeVoicemail","expressionAttrValues","email","sms","enabled","phoneNumber","updateExpression","UpdateExpression","update","values","batchWrite","GlobalSettingsService","globalRepo","getGlobalSettings","transcribe","encrypt","deliveryEmail","availableSMSCountries","updateGlobalSettings","result","console","log","stringify","Attributes","createGlobalSettings","DELIVERY_EMAIL","ConnectAgent","connectUser","super","connectService","usersRepo","getAgentByExtension","getConnectUser","user","getAgentByUserId","getAgents","Promise","all","listConnectUsers","getAllAgents","connectUsers","dbUsers","needUpdate","forEach","found","find","dbUser","Id","username","Username","push","PutRequest","createAgentCreateParam","DeleteRequest","createAgentDeleteParam","_validateAgentUpdate","createAgentIfNeeded","updateAgentById","getConnectAgentByUserId","createAgentPromise","createAgent","resolve","reject","undefined","phone","isValid","getNumber","Number","isNaN","globalSettingsService","notificationService","agentService","voicemailRepo","voicemailService","async","event","context","detail","jobName","jobStatus","updateVoicemailTranscriptStatus","lambdaResult","err","trace","ConnectUser","userMap","arn","firstName","lastName","phoneType","autoAccept","deskPhoneNumber","directoryUserId","routingProfileId","AWS","instanceId","split","connect","Connect","maxBackOffTime","users","promises","map","InstanceId","UserId","describeUser","User","_listConnectUsers","list","nextToken","retry","MaxResults","listUsers","promise","UserSummaryList","NextToken","concat","catch","warn","Math","min","pow","setTimeout","GlobalSettings","globalSettingsMap","AVAILABLE_SMS_COUNTRIES","GLOBAL_TABLE_NAME","amazonConnectInstanceArn","instanceArn","settings","_updateGlobalSettings","GenericError","Error","message","developerMessage","MissingParameterError","parameter","InvalidParameterError","MissingParametersError","ContactVoicemailRepo","CONTACT_VOICEMAIL_TABLE_NAME","contactId","timestamp","status","queryParam","queryResult","readerId","DeliveryOptionSettings","DeliveryContent","transcription","preSignedUrl","audioFile","NotificationService","s3Service","transcriptionService","ses","SES","sns","SNS","transporter","createTransport","recordingExpiration","parseInt","SIGNED_RECORDING_URL_EXP","globalSettings","voicemail","connectAgent","options","getTranscribeAndEncryptionSettings","deliveryOptions","shouldSendEmail","shouldSendSMS","contactEmail","agentSMSPhoneNumber","getDeliveryContents","contents","sendTextMessage","sendMail","transcriptionPromise","preSignedUrlPromise","audioFilePromise","getPreSignedUrl","recordingBucketName","recordingObjectKey","getFile","getTranscriptJobName","getTranscriptForJobName","fromEmailAddress","toEmailAddress","deliveryContent","html","Date","contactPhoneNumber","transcripts","transcript","floor","now","expires","url","mailOptions","subject","to","filename","content","Body","info","deliveryPhoneNumber","Message","PhoneNumber","publish","shouldTranscribe","shouldEncrypt","require","S3Service","secretsManager","SecretsManager","getAWSCredentials","getSecretValue","SecretId","SECRET_ARN","res","isTempToken","secret","SecretString","jsonParsed","accessKeyId","secretAccessKey","s3","S3","signatureVersion","credentials","bucket","Bucket","getObject","Expires","getSignedUrl","TranscriptionService","TranscribeService","TranscriptionJobName","getTranscriptionJob","transcriptionJob","method","uri","TranscriptionJob","Transcript","TranscriptFileUri","json","results","ContactVoicemail","voicemailMap","transcribeStatus","recordingUrl","recordingBucketRegion","jobNameSplit","updateTranscriptionStatus","eventName","newRecord","oldRecord","newVoicemail","_deliver","getSettings","deliver","DynamoDBService","tableName","client","DynamoDB","DocumentClient","Items","allItems","LastEvaluatedKey","callback","batch","startingIndex","_batchWrite","index","nextData","endIndex","batchToUpdate","slice","batchParam","RequestItems","Agent","agentMap"],"mappings":"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","file":"transcription.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 1207);\n","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved. \n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                              \n *      http://www.apache.org/licenses/                                        \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                              \n******************************************************************************/\n\nimport {DynamoDBService} from \"../lib/dynamo\";\nimport {Agent} from \"../domain/agent.domain\";\n\nclass UsersRepo {\n\n    constructor() {\n        this.dynamo = new DynamoDBService(process.env.USERS_TABLE_NAME);\n        this.amazonConnectInstanceId = process.env.AMAZON_CONNECT_INSTANCE_ARN;\n    }\n\n    /**\n     * @param extension\n     * @returns {Promise<object>}\n     */\n    getAgentByExtension(extension) {\n        let params = {\n            IndexName: \"AgentExtensionIndex\",\n            KeyConditionExpression: \"extension = :ext\",\n            ExpressionAttributeValues: {\n                \":ext\": extension\n            },\n        };\n        return this.dynamo.query(params)\n            .then(items => {\n                return items.length > 0 ? new Agent(items[0]) : null;\n            });\n    }\n\n    getAgentByUserId(userId) {\n        let params = {\n            Key: {\n                agentId: userId\n            }\n        };\n        return this.dynamo.getItem(params).then(item => {\n            return item ? new Agent(item) : null;\n        });\n    }\n\n    getAgents(next, size) {\n        let param = {\n            Limit: size || 1000,\n            Select: \"ALL_ATTRIBUTES\"\n        };\n\n        if (next) {\n            param.ExclusiveStartKey = JSON.parse(Buffer.from(next, 'base64').toString('utf-8'));\n        }\n\n        return this.dynamo\n            .scanWithNext(param);\n    }\n\n    getAllAgents() {\n        return this.dynamo\n            .scan({\n                Select: \"ALL_ATTRIBUTES\"\n            });\n    }\n\n    createAgentCreateParam(agent) {\n        let data = {\n            Item: {\n                ...agent,\n                agentId: agent.userId\n            }\n        };\n        if (agent.extension === \"\") {\n            delete data.Item.extension;\n        }\n\n        return data;\n    }\n\n    createAgentDeleteParam(agent) {\n        return {\n            Key: {\n                agentId: agent.userId\n            }\n        };\n    }\n\n    createAgent(agent) {\n        let params = this.createAgentData(agent)\n        return this.dynamo.put(params);\n    }\n\n    updateAgentById(agentId, {extension, deliverSMSPhoneNumber, deliverSMS, deliverEmail, encryptVoicemail, transcribeVoicemail}) {\n        let expressionAttrValues = {\n            \":tv\": transcribeVoicemail || false,\n            \":ev\": encryptVoicemail || false,\n            \":de\": deliverEmail,\n            \":do\": {\n                email: deliverEmail,\n                sms: {\n                    enabled: deliverSMS,\n                    phoneNumber: deliverSMSPhoneNumber === \"\" ? \"null\" : deliverSMSPhoneNumber\n                }\n\n            }\n        };\n\n        if (extension !== null && extension !== \"\") {\n            expressionAttrValues[\":ext\"] = extension;\n        }\n        let updateExpression = \"SET transcribeVoicemail=:tv, encryptVoicemail = :ev, deliveryEmail = :de, deliveryOptions = :do\";\n        (extension === null || extension === \"\") ? updateExpression += ` REMOVE extension` : updateExpression += `, extension = :ext`;\n\n        let params = {\n            Key: {\n                agentId: agentId\n            },\n            ExpressionAttributeValues: expressionAttrValues,\n            UpdateExpression: updateExpression\n        };\n        return this.dynamo.update(params);\n    }\n\n    batchWrite(values) {\n        return this.dynamo.batchWrite(values, 0);\n    }\n}\n\nexport {UsersRepo};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved. \n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                              \n *      http://www.apache.org/licenses/                                        \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                              \n******************************************************************************/\n\nclass GlobalSettingsService {\n\n    constructor(globalRepo) {\n        this.globalRepo = globalRepo;\n    }\n\n    getSettings() {\n        return this.globalRepo.getGlobalSettings();\n    }\n\n    update(transcribe, encrypt, deliveryEmail, availableSMSCountries) {\n        return this.globalRepo.updateGlobalSettings(transcribe, encrypt, deliveryEmail, availableSMSCountries)\n            .then(result => {\n                console.log(\"Result: \" + JSON.stringify(result));\n                let {transcribeVoicemail, encryptVoicemail, deliveryEmail, availableSMSCountries} = result.Attributes;\n                return {\n                    transcribeVoicemail,\n                    encryptVoicemail,\n                    deliveryEmail,\n                    availableSMSCountries\n                };\n            });\n    }\n\n    createDefault() {\n        return this.globalRepo.createGlobalSettings(true, true, process.env.DELIVERY_EMAIL);\n    }\n\n}\n\nexport {GlobalSettingsService};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.                                           *                                                                                                                   *\n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                                                                   \n *      http://www.apache.org/licenses/                                                                                   *                                                                                                                  \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                                                                \n******************************************************************************/\n\nclass ConnectAgent {\n\n    /**\n     * @param {Agent} agent\n     * @param {ConnectUser} connectUser\n     */\n    constructor(agent, connectUser) {\n        this.userId = agent.userId;\n        this.agent = agent;\n        this.connectUser = connectUser;\n    }\n\n}\n\nexport {ConnectAgent};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.                                           *                                                                                                                   *\n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                                                                   \n *      http://www.apache.org/licenses/                                                                                   *                                                                                                                  \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                                                                \n******************************************************************************/\n\nimport {GenericError} from \"./standard.errors\";\n\nclass ExtensionNumberRequiredError extends GenericError {\n    constructor() {\n        super(\n            \"ExtensionNumberRequiredError\",\n            \"Please provide an extension number.\",\n            \"Extension number is required to update an agent\"\n        );\n    }\n}\n\nclass ExtensionInUseError extends GenericError {\n    constructor(extension) {\n        super(\n            \"ExtensionInUseError\",\n            \"Extension already in use. Please provide a different extension number.\",\n            `Cannot have more than one user assigned to the extension number: ${extension}`\n        );\n    }\n}\n\nexport {\n    ExtensionNumberRequiredError,\n    ExtensionInUseError\n};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved. \n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                              \n *      http://www.apache.org/licenses/                                        \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                              \n******************************************************************************/\n\nimport {ConnectAgent} from \"../domain/connect-agent.domain\";\nimport {\n    MissingParameterError,\n    InvalidParameterError, MissingParametersError, GenericError\n} from \"../errors/standard.errors\";\nimport {Agent} from \"../domain/agent.domain\";\nimport {\n    ExtensionInUseError\n} from \"../errors/agent.errors\";\n\nimport PhoneNumber from 'awesome-phonenumber';\n\nclass ConnectAgentService {\n\n    constructor(connectService, usersRepo) {\n        this.usersRepo = usersRepo;\n        this.connectService = connectService;\n    }\n\n    /**\n     * @param extension\n     * @returns {Promise<ConnectAgent>}\n     */\n    getConnectAgentByExtension(extension) {\n        return this.usersRepo.getAgentByExtension(extension)\n            .then(agent => this.connectService.getConnectUser(agent.userId)\n                .then(connectUser => new ConnectAgent(agent, connectUser)));\n    }\n\n    /**\n     * @param userId\n     * @returns {Promise<ConnectAgent>}\n     */\n    getConnectAgentByUserId(userId) {\n        return this.connectService.getConnectUser(userId)\n            .then(user => this.usersRepo.getAgentByUserId(userId)\n                .then(agent => new ConnectAgent(agent, user)));\n    }\n\n    /**\n     * @returns {Promise<ConnectAgent[]>}\n     */\n    getConnectAgents(next, size) {\n        return this.usersRepo.getAgents(next, size);\n    }\n\n    syncConnectAgents() {\n        // collect all users in the system\n        return Promise.all([this.connectService.listConnectUsers(), this.usersRepo.getAllAgents()])\n            .then(values => {\n                let [connectUsers, dbUsers] = values;\n                let needUpdate = [];\n\n                connectUsers.forEach(connectUser => {\n                    const found = dbUsers.find(dbUser => dbUser.userId === connectUser.Id);\n                    let agent;\n                    if (found && found.username !== connectUser.Username) {\n                        agent = {\n                            ...found,\n                            username: connectUser.Username\n                        };\n                        needUpdate.push({PutRequest:this.usersRepo.createAgentCreateParam(agent)});\n                    } else if (!found) {\n                        agent = {\n                            userId: connectUser.Id,\n                            username: connectUser.Username\n                        };\n                        needUpdate.push({PutRequest: this.usersRepo.createAgentCreateParam(agent)});\n                    }\n                });\n\n                dbUsers.forEach(dbUser => {\n                    const found = connectUsers.find(connectUser => connectUser.Id === dbUser.userId);\n                    if (!found) {\n                        needUpdate.push({DeleteRequest: this.usersRepo.createAgentDeleteParam(dbUser)});\n                    }\n                });\n\n                if(needUpdate.length > 0) {\n                    return this.usersRepo.batchWrite(needUpdate);\n                }\n            });\n    }\n\n    updateAgentById(agentId, update) {\n        return this._validateAgentUpdate(agentId, update)\n            .then(() => this.createAgentIfNeeded(agentId, update.extension))\n            .then(() => this.usersRepo.updateAgentById(agentId, update))\n            .then(() => this.getConnectAgentByUserId(agentId));\n    }\n\n    createAgentIfNeeded(agentId, extension) {\n        let createAgentPromise = this.usersRepo.getAgentByUserId(agentId).then(agent => {\n            if (agent === null) return this.usersRepo.createAgent(Agent.create(agentId, extension));\n            return agent;\n        });\n        if (extension) {\n            return this.usersRepo.getAgentByExtension(extension)\n                .then(agent => {\n                    if (agent != null && agent.userId !== agentId) {\n                        throw new ExtensionInUseError(extension);\n                    }\n                    return agent;\n                }).then(() => createAgentPromise);\n        } else {\n            return createAgentPromise;\n        }\n    }\n\n    _validateAgentUpdate(agentId, update) {\n        return new Promise((resolve, reject) => {\n            let {extension, deliverSMSPhoneNumber, deliverSMS, deliverEmail, encryptVoicemail, transcribeVoicemail} = update;\n            if (!agentId) {\n                reject(new MissingParameterError(\"agentId\"));\n                return;\n            }\n\n            if (deliverSMS === true && (deliverSMSPhoneNumber === undefined || deliverSMSPhoneNumber === \"\")) {\n                reject(new InvalidParameterError(\n                    \"Please provide a phone number for SMS delivery\",\n                    \"deliverSMSPhoneNumber cannot be null or empty if deliverSMS is true\"));\n                return;\n            }\n\n            if (deliverSMSPhoneNumber) {\n                let phone = new PhoneNumber(deliverSMSPhoneNumber);\n                if (!phone.isValid()) {\n                    reject(new GenericError(\n                        \"InvalidPhoneNumberError\",\n                        \"The phone number you've entered is invalid.  Please enter a valid phone number and try again.\",\n                        `Phone number cannot be validated for ${deliverSMSPhoneNumber}`\n                    ));\n                } else {\n                    update[\"deliverSMSPhoneNumber\"] = phone.getNumber();\n                }\n            }\n\n            if (update.hasOwnProperty(\"extension\") &&\n                (update[\"extension\"].length > 5 || Number.isNaN(update[\"extension\"]))) {\n                reject(new InvalidParameterError(\"Invalid extension number\", \"Extension number must be numeric and less than 5 digits.\"));\n                return;\n            }\n\n            if (!update.hasOwnProperty(\"extension\") ||\n                !update.hasOwnProperty(\"deliverSMS\") ||\n                !update.hasOwnProperty(\"deliverEmail\") ||\n                !update.hasOwnProperty(\"transcribeVoicemail\") ||\n                !update.hasOwnProperty(\"encryptVoicemail\")\n            ) {\n                reject(new MissingParametersError());\n                return;\n            }\n\n            resolve({\n                agentId,\n                update\n            });\n        });\n    }\n\n}\n\nexport {ConnectAgentService};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.                                           *                                                                                                                   *\n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                                                                   \n *      http://www.apache.org/licenses/                                                                                   *                                                                                                                  \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                                                                \n******************************************************************************/\n\nimport {ContactVoicemailRepo} from \"../repo/voicemail.repo\";\nimport {ContactVoicemailService} from \"../service/voicemail.service\";\nimport {ConnectAgentService} from \"../service/connect-agent.service\";\nimport {ConnectService} from \"../service/connect.service\";\nimport {UsersRepo} from \"../repo/users-repo\";\nimport {NotificationService} from \"../service/notification.service\";\nimport {S3Service} from \"../service/s3.service\";\nimport {TranscriptionService} from \"../service/transcription.service\";\nimport {GlobalSettingsService} from \"../service/global-settings.services\";\nimport {GlobalRepo} from \"../repo/global-repo\";\n\nconst usersRepo = new UsersRepo();\nconst globalRepo = new GlobalRepo();\nconst globalSettingsService = new GlobalSettingsService(globalRepo);\nconst notificationService = new NotificationService(new S3Service(), new TranscriptionService());\nconst agentService = new ConnectAgentService(new ConnectService(), usersRepo);\nconst voicemailRepo = new ContactVoicemailRepo();\nconst voicemailService = new ContactVoicemailService(voicemailRepo, agentService, notificationService, globalSettingsService);\n\nexports.process = async(event, context) => {\n    let {detail} = event;\n    let jobName = detail[\"TranscriptionJobName\"];\n    let jobStatus = detail[\"TranscriptionJobStatus\"];\n    try {\n        let result = await voicemailService.updateVoicemailTranscriptStatus(jobName, jobStatus);\n        return {\n            lambdaResult: \"Success\"\n        };\n    } catch (err) {\n        console.trace();\n        console.log(\"Error Processing Transcript. Error: \", JSON.stringify(err, null, 2));\n    }\n};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.                                           *                                                                                                                   *\n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                                                                   \n *      http://www.apache.org/licenses/                                                                                   *                                                                                                                  \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                                                                \n******************************************************************************/\n\nclass ConnectUser {\n\n    constructor(userMap, detail = true) {\n        this.userId = userMap[\"Id\"];\n        this.arn = userMap[\"Arn\"];\n        this.username = userMap[\"Username\"];\n\n        if (!detail) {\n            return;\n        }\n\n        this.firstName = userMap[\"IdentityInfo\"][\"FirstName\"];\n        this.lastName = userMap[\"IdentityInfo\"][\"LastName\"];\n        this.email = userMap[\"IdentityInfo\"][\"Email\"];\n\n        if (userMap.hasOwnProperty(\"PhoneConfig\")) {\n            this.phoneType = userMap[\"PhoneConfig\"][\"PhoneType\"];\n            this.autoAccept = userMap[\"PhoneConfig\"][\"AutoAccept\"];\n            this.deskPhoneNumber = userMap[\"PhoneConfig\"][\"DeskPhoneNumber\"];\n        } else {\n            this.phoneType = null;\n            this.autoAccept = null;\n            this.deskPhoneNumber = null;\n        }\n\n        this.directoryUserId = userMap[\"DirectoryUserId\"];\n        this.routingProfileId = userMap[\"RoutingProfileId\"];\n    }\n\n    getFullName() {\n        return `${this.firstName} ${this.lastName}`;\n    }\n\n}\n\nexport {ConnectUser};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved. \n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                              \n *      http://www.apache.org/licenses/                                        \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                              \n******************************************************************************/\n\nimport {ConnectUser} from \"../domain/connect-user.domain\";\n\nconst AWS = require('aws-sdk');\nconst delay = t => new Promise(resolve => setTimeout(resolve, t));\n\nclass ConnectService {\n\n    constructor() {\n        this.instanceId = process.env.AMAZON_CONNECT_INSTANCE_ARN.split('/')[1];\n        this.connect = new AWS.Connect();\n\n        // max backoff time set to 45 sec\n        this.maxBackOffTime = 45;\n    }\n\n\n    /**\n     * @returns {Promise<ConnectUser[]>}\n     */\n    getConnectUsers() {\n        return this.listConnectUsers()\n            .then(users => {\n                let promises = users.map(user => this.getConnectUser(user.Id));\n                return Promise.all(promises);\n            });\n    }\n\n    /**\n     *\n     * @param userId\n     * @returns {Promise<ConnectUser>}\n     */\n    getConnectUser(userId) {\n        return new Promise((resolve, reject) => {\n            let params = {\n                InstanceId: this.instanceId,\n                UserId: userId\n            };\n            this.connect.describeUser(params, (err, data) => {\n                if (err) {\n                    console.log(\"Error\", err);\n                    reject(err);\n                    return;\n                }\n                if (!data) {\n                    console.log(\"No user found\");\n                    reject(err);\n                    return;\n                }\n                resolve(new ConnectUser(data.User));\n            });\n        });\n    }\n\n    listConnectUsers() {\n        return this._listConnectUsers([], null, 0);\n    }\n\n\n    _listConnectUsers(list, nextToken, retry) {\n        let params = {\n            InstanceId: this.instanceId,\n            MaxResults: 1000\n        };\n        if (nextToken) {\n            params[\"NextToken\"] = nextToken;\n        }\n\n        return this.connect.listUsers(params)\n            .promise()\n            .then(data => {\n                let {UserSummaryList, NextToken} = data;\n                let users = list.concat(UserSummaryList);\n                if (NextToken) {\n                    return this._listConnectUsers(users, NextToken, 0);\n                } else {\n                    return users;\n                }\n            })\n            .catch(err => {\n                console.warn(\"list connect user failed. Retry: \" + retry, err);\n                if (retry > 5) {\n                    throw err;\n                }\n\n                return delay(Math.min(Math.pow(retry, 2), this.maxBackOffTime))\n                    .then(() => {\n                        return this._listConnectUsers(list, nextToken, retry + 1);\n                    })\n            });\n    }\n\n}\n\nexport {ConnectService};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.                                           *                                                                                                                   *\n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                                                                   \n *      http://www.apache.org/licenses/                                                                                   *                                                                                                                  \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                                                                \n******************************************************************************/\n\nclass GlobalSettings {\n\n    constructor(globalSettingsMap) {\n        this.transcribeVoicemail = globalSettingsMap[\"transcribeVoicemail\"] || false;\n        this.encryptVoicemail = globalSettingsMap[\"encryptVoicemail\"] || false;\n        this.deliveryEmail = globalSettingsMap[\"deliveryEmail\"] || null;\n        this.availableSMSCountries = globalSettingsMap[\"availableSMSCountries\"] || (process.env.AVAILABLE_SMS_COUNTRIES || \"\").split(\",\");\n    }\n\n}\n\nexport {GlobalSettings};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved. \n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                              \n *      http://www.apache.org/licenses/                                        \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                              \n******************************************************************************/\n\nimport {DynamoDBService} from \"../lib/dynamo\";\nimport {GlobalSettings} from \"../domain/global-settings.domain\";\n\nclass GlobalRepo {\n\n    constructor() {\n        this.dynamo = new DynamoDBService(process.env.GLOBAL_TABLE_NAME);\n        this.amazonConnectInstanceArn = process.env.AMAZON_CONNECT_INSTANCE_ARN;\n    }\n\n    getGlobalSettings() {\n        console.log(\"Getting Global Settings\");\n        let params = {\n            Key: {\n                instanceArn: this.amazonConnectInstanceArn\n            }\n        };\n        return this.dynamo.getItem(params).then(item => {\n            return item ? new GlobalSettings(item) : null;\n        });\n    }\n\n    createGlobalSettings(transcribeVoicemail, encryptVoicemail, deliveryEmail, availableSMSCountries) {\n        let settings = new GlobalSettings({transcribeVoicemail, encryptVoicemail, deliveryEmail, availableSMSCountries});\n        settings.instanceArn = this.amazonConnectInstanceArn;\n        let params = {\n            Item: settings\n        };\n        console.log(\"dynamo put\");\n        return this.dynamo.put(params).then(() => settings);\n    }\n\n    updateGlobalSettings(transcribeVoicemail, encryptVoicemail, deliveryEmail, availableSMSCountries) {\n        return this.getGlobalSettings().then(settings => {\n            if (settings) {\n                return this._updateGlobalSettings(transcribeVoicemail, encryptVoicemail, deliveryEmail, availableSMSCountries);\n            } else {\n                console.log(\"in create\");\n                return this.createGlobalSettings(transcribeVoicemail, encryptVoicemail, deliveryEmail, availableSMSCountries);\n            }\n        });\n    }\n\n    _updateGlobalSettings(transcribeVoicemail, encryptVoicemail, deliveryEmail, availableSMSCountries) {\n        let params = {\n            Key: {\n                instanceArn: this.amazonConnectInstanceArn\n            },\n            ExpressionAttributeValues: {\n                \":tv\": transcribeVoicemail,\n                \":ev\": encryptVoicemail,\n                \":de\": deliveryEmail,\n                \":ac\": availableSMSCountries\n            },\n            UpdateExpression: \"SET transcribeVoicemail=:tv, encryptVoicemail=:ev, deliveryEmail=:de, availableSMSCountries=:ac\"\n        };\n        return this.dynamo.update(params);\n    }\n}\n\nexport {GlobalRepo};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.                                           *                                                                                                                   *\n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                                                                   \n *      http://www.apache.org/licenses/                                                                                   *                                                                                                                  \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                                                                \n******************************************************************************/\n\nclass GenericError extends Error {\n    constructor(name, message, developerMessage) {\n        super();\n        this.message = message;\n        this.developerMessage = developerMessage;\n        this.name = name;\n    }\n}\n\nclass MissingParameterError extends GenericError {\n    constructor(parameter) {\n        super(\n            \"MissingParameterError\",\n            `Missing parameter`,\n            `Missing parameter: ${parameter}`\n        );\n    }\n}\n\nclass InvalidParameterError extends GenericError {\n    constructor(message, developerMessage) {\n        super(\n            \"InvalidParameterValueError\",\n            message,\n            developerMessage\n        );\n    }\n}\n\nclass MissingParametersError extends GenericError {\n    constructor() {\n        super(\n            \"MissingParametersError\",\n            `One or more parameters are missing`,\n            `You have one ore more parameters miss, please see documentation for more information.`\n        );\n    }\n}\n\nexport {\n    GenericError,\n    MissingParameterError,\n    InvalidParameterError,\n    MissingParametersError\n};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved. \n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                              \n *      http://www.apache.org/licenses/                                        \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                              \n******************************************************************************/\n\nimport {DynamoDBService} from \"../lib/dynamo\";\n\nclass ContactVoicemailRepo {\n\n    constructor() {\n        this.dynamo = new DynamoDBService(process.env.CONTACT_VOICEMAIL_TABLE_NAME);\n    }\n\n    updateTranscriptionStatus(contactId, timestamp, status) {\n        // Query for all objects with the contact id\n        // Update each object with the new status\n        \n        let queryParam = {\n            KeyConditionExpression: 'contactId = :contactId',\n            ExpressionAttributeValues: {\n                ':contactId': contactId\n            }\n        };\n\n        return Promise.all([this.dynamo.query(queryParam)])\n            .then(values => {\n\n                let promises = [];\n                values[0].map(queryResult => {\n                    let params = {\n                        Key: {\n                            \"contactId\": contactId,\n                            \"readerId\": queryResult.readerId\n                        },\n                        ExpressionAttributeValues: {\n                            \":status\": status\n                        },\n                        UpdateExpression: \"SET transcribeStatus = :status\"\n                    };\n                    promises.push(this.dynamo.update(params));\n                });\n\n                return Promise.all(promises);\n            });\n    }\n\n}\n\nexport {ContactVoicemailRepo};\n","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved. \n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                              \n *      http://www.apache.org/licenses/                                        \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                              \n******************************************************************************/\n\nconst AWS = require('aws-sdk');\nimport nodemailer from 'nodemailer';\n\n\nclass DeliveryOptionSettings {\n    constructor(transcribe, encrypt) {\n        this.transcribe = transcribe;\n        this.encrypt = encrypt;\n    }\n}\n\nclass DeliveryContent {\n    constructor(transcription, preSignedUrl, audioFile) {\n        this.transcription = transcription;\n        this.preSignedUrl = preSignedUrl;\n        this.audioFile = audioFile;\n    }\n}\n\nclass NotificationService {\n\n    constructor(s3Service, transcriptionService) {\n        this.s3Service = s3Service;\n        this.transcriptionService = transcriptionService;\n        this.ses = new AWS.SES();\n        this.sns = new AWS.SNS();\n        this.transporter = nodemailer.createTransport({SES: this.ses});\n        this.recordingExpiration = parseInt(process.env.SIGNED_RECORDING_URL_EXP)\n    }\n\n    /**\n     *\n     * @param {GlobalSettings} globalSettings\n     * @param {ContactVoicemail} voicemail\n     * @param {ConnectAgent} connectAgent\n     * @return {Promise<Object>}\n     */\n    deliver(globalSettings, voicemail, connectAgent) {\n        let options = this.getTranscribeAndEncryptionSettings(globalSettings, voicemail);\n        let deliveryOptions = connectAgent.agent.deliveryOptions;\n        let shouldSendEmail = deliveryOptions.email;\n        let shouldSendSMS = deliveryOptions.sms.enabled;\n        let contactEmail = connectAgent.connectUser.email || connectAgent.connectUser.username; // For SSO instances\n        let agentSMSPhoneNumber = deliveryOptions.sms.phoneNumber;\n        let deliveryEmail = globalSettings.deliveryEmail;\n\n        if (!deliveryEmail) {\n            throw \"You must provide a delivery email\";\n        }\n\n        if (!shouldSendEmail && !shouldSendSMS) {\n            console.log(\"NOT sending email or sms\");\n            return Promise.resolve({message: \"Not sending Email or SNS\"});\n        } else {\n            if (shouldSendEmail && shouldSendSMS) {\n                console.log(`Should Send BOTH email and SMS`);\n                return this.getDeliveryContents(options, voicemail).then(contents => {\n                    return this.sendTextMessage(voicemail, agentSMSPhoneNumber, contents)\n                        .then(() => this.sendMail(voicemail, deliveryEmail, contactEmail, contents));\n                });\n            } else if (shouldSendSMS && agentSMSPhoneNumber) {\n                console.log(\"Send ONLY SMS\");\n                return this.getDeliveryContents(options, voicemail).then(contents => {\n                    return this.sendTextMessage(voicemail, agentSMSPhoneNumber, contents);\n                });\n            } else if (deliveryOptions.email) {\n                console.log(\"Send ONLY Email\");\n                return this.getDeliveryContents(options, voicemail).then(contents => {\n                    return this.sendMail(voicemail, deliveryEmail, contactEmail, contents);\n                });\n            } else {\n                return Promise.resolve({message: \"Undeliverable\"});\n            }\n        }\n    }\n\n    /**\n     * @param {ContactVoicemail} voicemail\n     * @param {DeliveryOptionSettings} options\n     * @returns {Promise<DeliveryContent>}\n     */\n    getDeliveryContents(options, voicemail) {\n        console.log(\"Getting Delivery Contents\");\n\n        let transcriptionPromise = Promise.resolve(null);\n        let preSignedUrlPromise = Promise.resolve(null);\n        let audioFilePromise = Promise.resolve(null);\n\n        if (options.encrypt) {\n            console.log(\"Encrypt...\");\n            preSignedUrlPromise = this.s3Service.getPreSignedUrl(voicemail.recordingBucketName, voicemail.recordingObjectKey, this.recordingExpiration);\n        } else {\n            console.log(\"Unencrypted...\");\n            audioFilePromise = this.s3Service.getFile(voicemail.recordingBucketName, voicemail.recordingObjectKey);\n        }\n\n        if (options.transcribe) {\n            console.log(\"Transcribe...\");\n            let jobName = voicemail.getTranscriptJobName();\n            transcriptionPromise = this.transcriptionService.getTranscriptForJobName(jobName);\n        }\n\n        return Promise\n            .all([transcriptionPromise, preSignedUrlPromise, audioFilePromise])\n            .then(result => {\n                let transcription = result[0];\n                let preSignedUrl = result[1];\n                let audioFile = result[2];\n                return new DeliveryContent(transcription, preSignedUrl, audioFile);\n            });\n    }\n\n    /**\n     *\n     * @param {ContactVoicemail} voicemail\n     * @param {string} fromEmailAddress\n     * @param {string} toEmailAddress\n     * @param {DeliveryContent} deliveryContent\n     */\n    sendMail(voicemail, fromEmailAddress, toEmailAddress, deliveryContent) {\n        return new Promise((resolve, reject) => {\n            let voicemailDate = new Date(voicemail.timestamp * 1000);\n\n            // Date\n            let html = `<p>${voicemailDate}</p>`;\n            html += `<p>New voicemail from ${voicemail.contactPhoneNumber}.</p>`;\n\n            // Transcript\n            if (deliveryContent.transcription) {\n                html += `<b>Voicemail Transcript:</b><p>${deliveryContent.transcription.transcripts[0].transcript}</p>`;\n            }\n\n            // Voicemail\n            html += `<b>Voicemail:</b>`;\n            if (deliveryContent.preSignedUrl) {\n                // Expiration Date\n                let expirationDate = new Date(Math.floor((Date.now() / 1000) + deliveryContent.preSignedUrl.expires) * 1000);\n                html += `<p>Voicemail Expiration Date: ${expirationDate}</p>`;\n\n                // Audio Link\n                let audioLink = `<p><a href=\"${deliveryContent.preSignedUrl.url}\">Click Here</a> to listen to the voicemail</p>`;\n                html += audioLink;\n            }\n\n            let mailOptions = {\n                from: fromEmailAddress,\n                subject: `New voicemail from ${voicemail.contactPhoneNumber}`,\n                html,\n                to: toEmailAddress\n            };\n\n            // Audio Attachment\n            if (deliveryContent.audioFile) {\n                mailOptions[\"attachments\"] = [{\n                    filename: \"voicemail.wav\",\n                    content: deliveryContent.audioFile.Body\n                }];\n            }\n\n            this.transporter.sendMail(mailOptions, (err, info) => {\n                if (err) {\n                    console.log(err);\n                    reject(err);\n                    return;\n                }\n                resolve(info);\n            });\n        });\n    }\n\n    /**\n     *\n     * @param {ContactVoicemail} voicemail\n     * @param {string} deliveryPhoneNumber\n     * @param {DeliveryContent} deliveryContent\n     */\n    sendTextMessage(voicemail, deliveryPhoneNumber, deliveryContent) {\n        return new Promise((resolve, reject) => {\n\n            let message = `Amazon Connect voicemail from ${voicemail.contactPhoneNumber}\\n`;\n\n            // Transcript\n            if (deliveryContent.transcription) {\n                message += `\\nTranscript: \"${deliveryContent.transcription.transcripts[0].transcript}\"\\n`;\n            }\n\n            if (deliveryContent.preSignedUrl) {\n                // Expiration Date\n                let expirationDate = new Date(Math.floor((Date.now() / 1000) + deliveryContent.preSignedUrl.expires) * 1000);\n                message += `\\nVoicemail Expiration Date: ${expirationDate}\\n`;\n\n                // Audio Link\n                let audioLink = `${deliveryContent.preSignedUrl.url}`;\n                message += audioLink;\n            }\n\n            let params = {\n                Message: message,\n                PhoneNumber: deliveryPhoneNumber\n            };\n\n            this.sns.publish(params, (err, data) => {\n                if (err) {\n                    console.log(`Error: ${err}`);\n                }\n                resolve(data);\n            });\n        });\n\n    }\n\n    /**\n     *\n     * @param {GlobalSettings} globalSettings\n     * @param {ContactVoicemail} voicemail\n     * @returns DeliveryOptionSettings\n     */\n    getTranscribeAndEncryptionSettings(globalSettings, voicemail) {\n        let transcribe = false;\n        let encrypt = true;\n\n        if (globalSettings.transcribeVoicemail === true) {\n            transcribe = voicemail.shouldTranscribe;\n        }\n\n        if (globalSettings.encryptVoicemail === false) {\n            encrypt = voicemail.shouldEncrypt;\n        }\n\n        return new DeliveryOptionSettings(transcribe, encrypt);\n    }\n\n}\n\nexport {NotificationService, DeliveryOptionSettings};","module.exports = require(\"nodemailer\");","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved. \n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                              \n *      http://www.apache.org/licenses/                                        \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                              \n******************************************************************************/\n\nconst AWS = require('aws-sdk');\n\nclass S3Service {\n    constructor() {\n        this.secretsManager = new AWS.SecretsManager();\n\n        const getAWSCredentials = async() => {\n            const results = await this.secretsManager.getSecretValue({SecretId: process.env.SECRET_ARN}).promise()\n            .then((res) => {\n                return res;\n            })\n            .catch((err) => {\n                console.log('error ', err);\n                return err;\n            });\n            return results;\n        };\n        \n        (async () => {\n            const data = await getAWSCredentials()\n            this.isTempToken = false;\n            if ('SecretString' in data) {\n                var secret = data.SecretString;\n                var jsonParsed = JSON.parse(secret);\n                var accessKeyId = jsonParsed.accessKeyId;\n                var secretAccessKey = jsonParsed.secretAccessKey;\n                // Creating a S3 client to include the access key ID and secret access key of an IAM user and to use AWS Signature Version 4\n                this.s3 = new AWS.S3({\n                    signatureVersion: 'v4',\n                    credentials: {\n                        secretAccessKey: secretAccessKey,\n                        accessKeyId: accessKeyId\n                    }\n                });\n            } else {\n                this.isTempToken = true;\n                // Creating a S3 client using temporary credentials of Lambda IAM Role\n                this.s3 = new AWS.S3();\n            }\n        })()\n    }\n\n    getFile(bucket, key) {\n        let params = {\n            Bucket: bucket,\n            Key: key\n        };\n        return this.s3.getObject(params).promise();\n    }\n\n    getPreSignedUrl(bucket, key, expires=900) {\n        return new Promise((resolve, reject) => {\n            const TWELVE_HOURS = 43200; // 12 hours in seconds\n            if (!this.isTempToken) {\n                console.log('Creating a pre-signed URL valid up to ' + expires + ' seconds using IAM User Access Key.');\n            } else {\n                if (expires > TWELVE_HOURS) {\n                    console.log('Could not create a presigned URL valid for greater than 12 hours because there was an error while retrieving the IAM User Access Key credentials from the AWS Secrets Manager (please refer to CloudWatch Logs for details). So creating a presigned URL valid up to 12 hours using temporary credentials of Lambda IAM Role.');\n                    expires = TWELVE_HOURS;\n                } \n            }\n            let params = {\n                Bucket: bucket,\n                Key: key,\n                Expires: expires\n            };\n            return this.s3.getSignedUrl('getObject', params, (err, url) => {\n                if (err) {\n                    reject(err);\n                    return;\n                }\n                resolve({\n                    url,\n                    expires\n                });\n            });\n        });\n    }\n}\n\nexport {S3Service};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved. \n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                              \n *      http://www.apache.org/licenses/                                        \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                              \n******************************************************************************/\n\nconst AWS = require('aws-sdk');\nimport rp from 'request-promise';\n\nclass TranscriptionService {\n\n    constructor() {\n        this.transcribe = new AWS.TranscribeService();\n    }\n\n    getTranscriptForJobName(jobName) {\n        let params = {\n            TranscriptionJobName: jobName\n        };\n        return this.transcribe\n            .getTranscriptionJob(params).promise()\n            .then(transcriptionJob => {\n                let options = {\n                    method: 'GET',\n                    uri: transcriptionJob.TranscriptionJob.Transcript.TranscriptFileUri,\n                    json: true\n                };\n                return rp(options).then(transcript => {\n                    return {\n                        transcriptionJob,\n                        transcripts: transcript.results.transcripts || null\n                    };\n                });\n            })\n            .catch(err => {\n                console.log(err);\n            });\n    }\n}\n\nexport {TranscriptionService};","module.exports = require(\"request-promise\");","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.                                           *                                                                                                                   *\n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                                                                   \n *      http://www.apache.org/licenses/                                                                                   *                                                                                                                  \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                                                                \n******************************************************************************/\n\nclass ContactVoicemail {\n\n    constructor(voicemailMap) {\n        this.contactId = voicemailMap[\"contactId\"];\n        this.timestamp = voicemailMap[\"timestamp\"];\n        this.agentId = voicemailMap[\"readerId\"];\n        this.contactPhoneNumber = voicemailMap[\"contactPhoneNumber\"];\n        this.shouldTranscribe = voicemailMap[\"shouldTranscribe\"] || false;\n        this.shouldEncrypt = voicemailMap[\"shouldEncrypt\"] || false;\n        this.transcribeStatus = voicemailMap[\"transcribeStatus\"];\n        this.recordingUrl = voicemailMap[\"recordingUrl\"];\n        this.recordingBucketName = voicemailMap[\"recordingBucketName\"];\n        this.recordingObjectKey = voicemailMap[\"recordingObjectKey\"];\n        this.recordingBucketRegion = voicemailMap[\"recordingBucketRegion\"];\n    }\n\n    getTranscriptJobName() {\n        return `${this.contactId}_${this.timestamp}`;\n    }\n\n}\n\nexport {ContactVoicemail};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved. \n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                              \n *      http://www.apache.org/licenses/                                        \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                              \n******************************************************************************/\n\nimport {ContactVoicemail} from \"../domain/voicemail.domain\";\n\nclass ContactVoicemailService {\n\n    constructor(voicemailRepo, agentService, notificationService, globalSettingsService) {\n        this.voicemailRepo = voicemailRepo;\n        this.agentService = agentService;\n        this.notificationService = notificationService;\n        this.globalSettingsService = globalSettingsService;\n    }\n\n    updateVoicemailTranscriptStatus(jobName, status) {\n        let jobNameSplit = jobName.split(\"_\");\n        let contactId = jobNameSplit[0];\n        let timestamp = parseInt(jobNameSplit[1]);\n        return this.voicemailRepo.updateTranscriptionStatus(contactId, timestamp, status);\n    }\n\n    processVoicemailRecords(eventName, newRecord, oldRecord) {\n        console.log(\"Processing Voicemail Recording\");\n        let newVoicemail = new ContactVoicemail(newRecord);\n        let oldVoicemail = new ContactVoicemail(oldRecord);\n\n        let transcribeCompleted = (oldVoicemail.transcribeStatus === \"IN_PROGRESS\" && newVoicemail.transcribeStatus === \"COMPLETED\");\n        if (transcribeCompleted) {\n            return this._deliver(newVoicemail);\n        } else if (newVoicemail.transcribeStatus === null || newVoicemail.transcribeStatus === undefined) {\n            return this._deliver(newVoicemail);\n        } else {\n            return Promise.resolve({message: \"Unhandled Resolution\"});\n        }\n    }\n\n    _deliver(voicemail) {\n        return Promise.all([this.globalSettingsService.getSettings(), this.agentService.getConnectAgentByUserId(voicemail.agentId)])\n            .then(result => {\n                let globalSettings = result[0];\n                let connectAgent = result[1];\n                return this.notificationService.deliver(globalSettings, voicemail, connectAgent);\n            });\n    }\n\n}\n\nexport {ContactVoicemailService};","module.exports = require(\"aws-sdk\");","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved. \n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                              \n *      http://www.apache.org/licenses/                                        \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                              \n******************************************************************************/\n\nconst AWS = require(\"aws-sdk\");\n\nclass DynamoDBService {\n\n    constructor(tableName) {\n        this.tableName = tableName;\n        this.client = new AWS.DynamoDB.DocumentClient();\n    }\n\n    /**\n     * @param params\n     * @returns {Promise<Object>}\n     */\n    update(params) {\n        params[\"TableName\"] = this.tableName;\n        params[\"ReturnValues\"] = \"ALL_NEW\";\n        return this.client.update(params).promise();\n    }\n\n    put(params) {\n        params[\"TableName\"] = this.tableName;\n        return this.client.put(params).promise();\n    }\n\n    /**\n     * @param params\n     * @returns {Promise<DocumentClient.AttributeMap[] | null>}\n     */\n    query(params) {\n        params[\"TableName\"] = this.tableName;\n        return this.client.query(params).promise().then(result => result.Items || null);\n    }\n\n    scan(params, items = []) {\n        params[\"TableName\"] = this.tableName;\n        return this.client.scan(params).promise().then(result => {\n            let allItems = items;\n\n            if (result.Items) {\n                allItems = items.concat(result.Items);\n            }\n            if (result.LastEvaluatedKey){\n                console.log(\"Rescanning with next page\");\n                params.ExclusiveStartKey = result.LastEvaluatedKey;\n                return this.scan(params, allItems);\n            } else {\n                return allItems;\n            }\n        });\n    }\n\n    queryWithNext(params) {\n      params[\"TableName\"] = this.tableName;\n      return this.client.query(params).promise().then(result => {\n        let data = {\n          data: result.Items || []\n        };\n        if(result.LastEvaluatedKey) {\n          data.next = Buffer.from(JSON.stringify(result.LastEvaluatedKey), 'utf8').toString('base64');\n        }\n        return data;\n      });\n    }\n\n    scanWithNext(params) {\n        params[\"TableName\"] = this.tableName;\n        return this.client.scan(params).promise().then(result => {\n            let data = {\n                data: result.Items || []\n            };\n            if(result.LastEvaluatedKey) {\n                data.next = Buffer.from(JSON.stringify(result.LastEvaluatedKey), 'utf8').toString('base64');\n            }\n            return data;\n        });\n    }\n\n    /**\n     * @param params\n     * @param callback\n     * @returns {Promise<DocumentClient.AttributeMap | null>}\n     */\n    getItem(params, callback) {\n        params[\"TableName\"] = this.tableName;\n        return this.client.get(params).promise().then(result => result.Item || null);\n    }\n\n    batchWrite(batch, startingIndex) {\n        return new Promise((resolve, reject) => {\n            this._batchWrite(batch, startingIndex).then(result => {\n                if (batch.length > result.index) {\n                    this.batchWrite(batch, result.index).then(nextData => {\n                        resolve(nextData);\n                    });\n                } else {\n                    resolve(result.data);\n                }\n            });\n        });\n    }\n\n    _batchWrite(batch, startingIndex) {\n        return new Promise((resolve, reject) => {\n            // DDB has a limit of 25 items at once\n            let maxDdbUpdate = 24;\n            let endIndex = (batch.length > startingIndex + maxDdbUpdate) ? startingIndex + maxDdbUpdate : batch.length;\n            let batchToUpdate = batch.slice(startingIndex, endIndex);\n\n            let batchParam = {\n                RequestItems: {\n                    [this.tableName]: batchToUpdate\n                }\n            };\n            this.client.batchWrite(batchParam, (err, data) => {\n                if (err) {\n                    console.log(\"Any error? \" + JSON.stringify(err, null, 2));\n                }\n                resolve({'index': startingIndex + maxDdbUpdate, 'data': data});\n            });\n        });\n    }\n}\n\nexport {DynamoDBService};","/******************************************************************************\n *  Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.                                           *                                                                                                                   *\n *  Licensed under the Apache License Version 2.0 (the 'License'). You may not\n *  use this file except in compliance with the License. A copy of the License\n *  is located at                                                            \n *                                                                                                                   \n *      http://www.apache.org/licenses/                                                                                   *                                                                                                                  \n *  or in the 'license' file accompanying this file. This file is distributed on\n *  an 'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, express or\n *  implied. See the License for the specific language governing permissions and\n *  limitations under the License.                                                                                \n******************************************************************************/\n\nclass Agent {\n\n    constructor(agentMap) {\n        this.userId = agentMap[\"userId\"];\n        this.extension = agentMap[\"extension\"];\n        this.username = agentMap[\"username\"];\n        this.transcribeVoicemail = agentMap[\"transcribeVoicemail\"] || false;\n        this.encryptVoicemail = agentMap[\"encryptVoicemail\"] || false;\n        this.deliveryOptions = agentMap[\"deliveryOptions\"] || {\n            sms: {\n                enabled: false,\n                phoneNumber: null\n            },\n            email: false\n        };\n    }\n\n    static create(userId, extension = null) {\n        return new Agent({\n            userId, extension: extension, deliveryOptions: {\n                sms: {\n                    enabled: false,\n                    phoneNumber: null\n                },\n                email: false\n            }\n        });\n    }\n\n}\n\nexport {Agent};","module.exports = require(\"awesome-phonenumber\");"],"sourceRoot":""}