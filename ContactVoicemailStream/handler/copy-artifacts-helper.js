!function(e,o){for(var t in o)e[t]=o[t]}(exports,function(e){var o={};function t(r){if(o[r])return o[r].exports;var n=o[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,t),n.l=!0,n.exports}return t.m=e,t.c=o,t.d=function(e,o,r){t.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,o){if(1&o&&(e=t(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var n in e)t.d(r,n,function(o){return e[o]}.bind(null,n));return r},t.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(o,"a",o),o},t.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},t.p="",t(t.s=1202)}({1202:function(e,o,t){"use strict";console.log("Loading function");const r=t(8),n=t(15);t(19);let s=t(3),c=new s.S3;t(16);new s.APIGateway;o.handler=(e,o,t)=>{console.log("Event: "+JSON.stringify(e));let r="FAILED",n={};"Create"===e.RequestType?"copyObjects"===e.ResourceProperties.customAction?f(e.ResourceProperties.SourceBucket,e.ResourceProperties.DestBucket,e.ResourceProperties.Prefix,e.ResourceProperties.Objects,0,(function(s,c){s?(n={Error:"Copy objects function failed"},console.log([n.Error,":\n",s].join(""))):p(e.ResourceProperties.DestBucket,(function(s,c){s?(n={Error:"Get S3 Object Version function failed"},console.log([n.Error,":\n",s].join(""))):(r="SUCCESS",n={JarVersionId:c.LatestJarObjectVersion,ZipVersionId:c.LatestZipObjectVersion}),i(e,t,o.logStreamName,r,n)}))})):"cleanUpS3Bucket"===e.ResourceProperties.customAction&&(r="SUCCESS",n={},i(e,t,o.logStreamName,r,n)):"Delete"===e.RequestType?("cleanUpS3Bucket"===e.ResourceProperties.customAction&&u(e.ResourceProperties,(function(s,c){s?(n={Error:"Clean up S3 bucket function failed"},console.log([n.Error,":\n",s].join(""))):(r="SUCCESS",n={}),i(e,t,o.logStreamName,r,n)})),r="SUCCESS",i(e,t,o.logStreamName,r,n)):"copyObjects"===e.ResourceProperties.customAction&&l(e.ResourceProperties.DestBucket,(function(s,c){s?(n={Error:"Delete objects function failed"},console.log([n.Error,":\n",s].join(""))):f(e.ResourceProperties.SourceBucket,e.ResourceProperties.DestBucket,e.ResourceProperties.Prefix,e.ResourceProperties.Objects,0,(function(s,c){s?(n={Error:"Copy objects function failed"},console.log([n.Error,":\n",s].join(""))):p(e.ResourceProperties.DestBucket,(function(s,c){s?(n={Error:"Get S3 Object Version function failed"},console.log([n.Error,":\n",s].join(""))):(r="SUCCESS",n={JarVersionId:c.LatestJarObjectVersion,ZipVersionId:c.LatestZipObjectVersion}),i(e,t,o.logStreamName,r,n)}))}))}))};let i=function(e,o,t,s,c){const i=JSON.stringify({Status:s,Reason:"See the details in CloudWatch Log Stream: "+t,PhysicalResourceId:t,StackId:e.StackId,RequestId:e.RequestId,LogicalResourceId:e.LogicalResourceId,Data:c}),u=n.parse(e.ResponseURL),l={hostname:u.hostname,port:443,path:u.path,method:"PUT",headers:{"Content-Type":"","Content-Length":i.length}},a=r.request(l,e=>{o(null,"Successfully sent stack response!")});a.on("error",e=>{console.log("sendResponse Error:\n",e),o(e)}),a.write(i),a.end()},u=function(e,o){var t={Bucket:e.DestBucket};c.getBucketVersioning(t,(function(t,r){return t?(console.log("Error getting the bucket version: "+t),o(t,null)):(r.Status?(console.log("This is a versioned Bucket"),l(e.DestBucket,o)):(console.log("This is not a versioned bucket"),a(e.DestBucket,o)),o(null,"success"))}))},l=function(e,o){var t={Bucket:e};c.listObjectVersions(t,(function(t,r){if(t)console.log("error listing bucket objects "+t);else{for(var n=[],s=r.Versions,i=0;i<s.length;i+=1)n.push({Key:s[i].Key,VersionId:s[i].VersionId});var u=r.DeleteMarkers;for(i=0;i<u.length;i+=1)n.push({Key:u[i].Key,VersionId:u[i].VersionId}),console.log("deleteMarkerItemKey: "+u[i].Key+" deleteMarkerItemId: "+u[i].VersionId);var l={Bucket:e,Delete:{Objects:n}};c.deleteObjects(l,(function(e,t){if(e)return console.log("error deleting objects "+e),o(e,null);o(null,"success")}))}}))},a=function(e,o){var t={Bucket:e};c.listObjects(t,(function(e,t){if(e)console.log("error listing bucket objects "+e);else{for(var r=t.Contents,n=[],s=0;s<r.length;s+=1)n.push({Key:r[s].Key});var i={Bucket:bucket,Objects:n};c.deleteObjects(i,(function(e,t){if(e)return console.log("error deleting objects "+e),o(e,null);o(null,"success")}))}}))},f=function(e,o,t,r,n,s){if(r.length>n){let i="aws-connect-vm-serverless/"+r[n],u={CopySource:e+"/"+t+r[n],Bucket:o,Key:i};c.copyObject(u,(function(c,i){c&&console.log("Error copying file: "+c),f(e,o,t,r,n+1,(function(e,o){if(e)return console.log("Error copying object: "+r[n+1]+" "+e),s(e,null);s(null,o)}))}))}else s(null,[n,"files copied"].join(" "))},p=function(e,o){var t={Bucket:e};c.listObjectVersions(t,(function(e,t){if(!e){for(var r={},n=t.Versions,s=0;s<n.length;s+=1)"aws-connect-vm-serverless/aws-connect-vm-java.jar"===n[s].Key?r.LatestJarObjectVersion=n[s].VersionId:"aws-connect-vm-serverless/aws-connect-vm.zip"===n[s].Key&&(r.LatestZipObjectVersion=n[s].VersionId);return o(null,r)}console.log("error listing bucket objects "+e)}))}},15:function(e,o){e.exports=require("url")},16:function(e,o){e.exports=require("fs")},19:function(e,o){e.exports=require("uuid")},3:function(e,o){e.exports=require("aws-sdk")},8:function(e,o){e.exports=require("https")}}));
//# sourceMappingURL=copy-artifacts-helper.js.map