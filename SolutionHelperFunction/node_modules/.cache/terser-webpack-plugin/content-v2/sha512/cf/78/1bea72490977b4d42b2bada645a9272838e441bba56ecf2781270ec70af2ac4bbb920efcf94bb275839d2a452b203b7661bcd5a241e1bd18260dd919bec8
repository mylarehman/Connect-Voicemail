{"map":"{\"version\":3,\"sources\":[\"voicemail.js\"],\"names\":[\"e\",\"a\",\"i\",\"exports\",\"modules\",\"installedModules\",\"__webpack_require__\",\"moduleId\",\"module\",\"l\",\"call\",\"m\",\"c\",\"d\",\"name\",\"getter\",\"o\",\"Object\",\"defineProperty\",\"enumerable\",\"get\",\"r\",\"Symbol\",\"toStringTag\",\"value\",\"t\",\"mode\",\"__esModule\",\"ns\",\"create\",\"key\",\"bind\",\"n\",\"object\",\"property\",\"prototype\",\"hasOwnProperty\",\"p\",\"s\",\"10\",\"__webpack_exports__\",\"UsersRepo\",\"_lib_dynamo__WEBPACK_IMPORTED_MODULE_0__\",\"_domain_agent_domain__WEBPACK_IMPORTED_MODULE_1__\",\"[object Object]\",\"this\",\"dynamo\",\"process\",\"env\",\"USERS_TABLE_NAME\",\"amazonConnectInstanceId\",\"AMAZON_CONNECT_INSTANCE_ARN\",\"extension\",\"params\",\"IndexName\",\"KeyConditionExpression\",\"ExpressionAttributeValues\",\":ext\",\"query\",\"then\",\"items\",\"length\",\"userId\",\"Key\",\"agentId\",\"getItem\",\"item\",\"next\",\"size\",\"param\",\"Limit\",\"Select\",\"ExclusiveStartKey\",\"JSON\",\"parse\",\"Buffer\",\"from\",\"toString\",\"scanWithNext\",\"scan\",\"agent\",\"data\",\"Item\",\"createAgentData\",\"put\",\"deliverSMSPhoneNumber\",\"deliverSMS\",\"deliverEmail\",\"encryptVoicemail\",\"transcribeVoicemail\",\"expressionAttrValues\",\":tv\",\":ev\",\":de\",\":do\",\"email\",\"sms\",\"enabled\",\"phoneNumber\",\"updateExpression\",\"UpdateExpression\",\"update\",\"values\",\"batchWrite\",\"11\",\"GlobalSettingsService\",\"globalRepo\",\"getGlobalSettings\",\"transcribe\",\"encrypt\",\"deliveryEmail\",\"availableSMSCountries\",\"updateGlobalSettings\",\"result\",\"console\",\"log\",\"stringify\",\"Attributes\",\"createGlobalSettings\",\"DELIVERY_EMAIL\",\"12\",\"connect_agent_service_ConnectAgentService\",\"ConnectAgent\",\"connectUser\",\"standard_errors\",\"agent_domain\",\"agent_errors_ExtensionInUseError\",\"super\",\"external_awesome_phonenumber_\",\"external_awesome_phonenumber_default\",\"connectService\",\"usersRepo\",\"getAgentByExtension\",\"getConnectUser\",\"user\",\"getAgentByUserId\",\"getAgents\",\"Promise\",\"all\",\"listConnectUsers\",\"getAllAgents\",\"connectUsers\",\"dbUsers\",\"needUpdate\",\"forEach\",\"found\",\"find\",\"dbUser\",\"Id\",\"username\",\"Username\",\"push\",\"PutRequest\",\"createAgentCreateParam\",\"DeleteRequest\",\"createAgentDeleteParam\",\"_validateAgentUpdate\",\"createAgentIfNeeded\",\"updateAgentById\",\"getConnectAgentByUserId\",\"createAgentPromise\",\"createAgent\",\"resolve\",\"reject\",\"undefined\",\"phone\",\"isValid\",\"getNumber\",\"Number\",\"isNaN\",\"1208\",\"_service_notification_service__WEBPACK_IMPORTED_MODULE_0__\",\"_service_connect_agent_service__WEBPACK_IMPORTED_MODULE_1__\",\"_repo_voicemail_repo__WEBPACK_IMPORTED_MODULE_2__\",\"_service_voicemail_service__WEBPACK_IMPORTED_MODULE_3__\",\"_repo_users_repo__WEBPACK_IMPORTED_MODULE_4__\",\"_service_connect_service__WEBPACK_IMPORTED_MODULE_5__\",\"_service_s3_service__WEBPACK_IMPORTED_MODULE_6__\",\"_service_transcription_service__WEBPACK_IMPORTED_MODULE_7__\",\"_service_global_settings_services__WEBPACK_IMPORTED_MODULE_8__\",\"_repo_global_repo__WEBPACK_IMPORTED_MODULE_9__\",\"AWS\",\"voicemailService\",\"stream\",\"async\",\"event\",\"context\",\"Records\",\"promises\",\"map\",\"record\",\"eventName\",\"newRecord\",\"DynamoDB\",\"Converter\",\"unmarshall\",\"dynamodb\",\"NewImage\",\"oldRecord\",\"OldImage\",\"processVoicemailRecords\",\"lambdaResult\",\"err\",\"error\",\"13\",\"connect_service_ConnectService\",\"ConnectUser\",\"userMap\",\"detail\",\"arn\",\"firstName\",\"lastName\",\"phoneType\",\"autoAccept\",\"deskPhoneNumber\",\"directoryUserId\",\"routingProfileId\",\"instanceId\",\"split\",\"connect\",\"Connect\",\"maxBackOffTime\",\"users\",\"InstanceId\",\"UserId\",\"describeUser\",\"User\",\"_listConnectUsers\",\"list\",\"nextToken\",\"retry\",\"MaxResults\",\"listUsers\",\"promise\",\"UserSummaryList\",\"NextToken\",\"concat\",\"catch\",\"warn\",\"Math\",\"min\",\"pow\",\"setTimeout\",\"14\",\"global_repo_GlobalRepo\",\"GlobalSettings\",\"globalSettingsMap\",\"AVAILABLE_SMS_COUNTRIES\",\"GLOBAL_TABLE_NAME\",\"amazonConnectInstanceArn\",\"instanceArn\",\"settings\",\"_updateGlobalSettings\",\":ac\",\"2\",\"GenericError\",\"MissingParameterError\",\"InvalidParameterError\",\"MissingParametersError\",\"Error\",\"message\",\"developerMessage\",\"parameter\",\"21\",\"ContactVoicemailRepo\",\"CONTACT_VOICEMAIL_TABLE_NAME\",\"contactId\",\"timestamp\",\"status\",\"queryParam\",\":contactId\",\"queryResult\",\"readerId\",\":status\",\"22\",\"NotificationService\",\"nodemailer__WEBPACK_IMPORTED_MODULE_0__\",\"nodemailer__WEBPACK_IMPORTED_MODULE_0___default\",\"DeliveryOptionSettings\",\"DeliveryContent\",\"transcription\",\"preSignedUrl\",\"audioFile\",\"s3Service\",\"transcriptionService\",\"ses\",\"SES\",\"sns\",\"SNS\",\"transporter\",\"createTransport\",\"recordingExpiration\",\"parseInt\",\"SIGNED_RECORDING_URL_EXP\",\"globalSettings\",\"voicemail\",\"connectAgent\",\"options\",\"getTranscribeAndEncryptionSettings\",\"deliveryOptions\",\"shouldSendEmail\",\"shouldSendSMS\",\"contactEmail\",\"agentSMSPhoneNumber\",\"getDeliveryContents\",\"contents\",\"sendTextMessage\",\"sendMail\",\"transcriptionPromise\",\"preSignedUrlPromise\",\"audioFilePromise\",\"getPreSignedUrl\",\"recordingBucketName\",\"recordingObjectKey\",\"getFile\",\"jobName\",\"getTranscriptJobName\",\"getTranscriptForJobName\",\"fromEmailAddress\",\"toEmailAddress\",\"deliveryContent\",\"html\",\"Date\",\"contactPhoneNumber\",\"transcripts\",\"transcript\",\"floor\",\"now\",\"expires\",\"url\",\"mailOptions\",\"subject\",\"to\",\"filename\",\"content\",\"Body\",\"info\",\"deliveryPhoneNumber\",\"Message\",\"PhoneNumber\",\"publish\",\"shouldTranscribe\",\"shouldEncrypt\",\"23\",\"require\",\"24\",\"S3Service\",\"secretsManager\",\"SecretsManager\",\"getAWSCredentials\",\"getSecretValue\",\"SecretId\",\"SECRET_ARN\",\"res\",\"isTempToken\",\"secret\",\"SecretString\",\"jsonParsed\",\"accessKeyId\",\"secretAccessKey\",\"s3\",\"S3\",\"signatureVersion\",\"credentials\",\"bucket\",\"Bucket\",\"getObject\",\"Expires\",\"getSignedUrl\",\"25\",\"TranscriptionService\",\"request_promise__WEBPACK_IMPORTED_MODULE_0__\",\"request_promise__WEBPACK_IMPORTED_MODULE_0___default\",\"TranscribeService\",\"TranscriptionJobName\",\"getTranscriptionJob\",\"transcriptionJob\",\"method\",\"uri\",\"TranscriptionJob\",\"Transcript\",\"TranscriptFileUri\",\"json\",\"results\",\"26\",\"27\",\"voicemail_service_ContactVoicemailService\",\"ContactVoicemail\",\"voicemailMap\",\"transcribeStatus\",\"recordingUrl\",\"recordingBucketRegion\",\"voicemailRepo\",\"agentService\",\"notificationService\",\"globalSettingsService\",\"jobNameSplit\",\"updateTranscriptionStatus\",\"newVoicemail\",\"_deliver\",\"getSettings\",\"deliver\",\"3\",\"4\",\"DynamoDBService\",\"tableName\",\"client\",\"DocumentClient\",\"Items\",\"allItems\",\"LastEvaluatedKey\",\"callback\",\"batch\",\"startingIndex\",\"_batchWrite\",\"index\",\"nextData\",\"endIndex\",\"batchToUpdate\",\"slice\",\"batchParam\",\"RequestItems\",\"5\",\"Agent\",\"agentMap\",\"9\"],\"mappings\":\"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\"}","code":"!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,\"a\",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p=\"\",n(n.s=1208)}({10:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return i}));var r=n(4),s=n(5);class i{constructor(){this.dynamo=new r.a(process.env.USERS_TABLE_NAME),this.amazonConnectInstanceId=process.env.AMAZON_CONNECT_INSTANCE_ARN}getAgentByExtension(e){let t={IndexName:\"AgentExtensionIndex\",KeyConditionExpression:\"extension = :ext\",ExpressionAttributeValues:{\":ext\":e}};return this.dynamo.query(t).then(e=>e.length>0?new s.a(e[0]):null)}getAgentByUserId(e){let t={Key:{agentId:e}};return this.dynamo.getItem(t).then(e=>e?new s.a(e):null)}getAgents(e,t){let n={Limit:t||1e3,Select:\"ALL_ATTRIBUTES\"};return e&&(n.ExclusiveStartKey=JSON.parse(Buffer.from(e,\"base64\").toString(\"utf-8\"))),this.dynamo.scanWithNext(n)}getAllAgents(){return this.dynamo.scan({Select:\"ALL_ATTRIBUTES\"})}createAgentCreateParam(e){let t={Item:{...e,agentId:e.userId}};return\"\"===e.extension&&delete t.Item.extension,t}createAgentDeleteParam(e){return{Key:{agentId:e.userId}}}createAgent(e){let t=this.createAgentData(e);return this.dynamo.put(t)}updateAgentById(e,{extension:t,deliverSMSPhoneNumber:n,deliverSMS:r,deliverEmail:s,encryptVoicemail:i,transcribeVoicemail:a}){let o={\":tv\":a||!1,\":ev\":i||!1,\":de\":s,\":do\":{email:s,sms:{enabled:r,phoneNumber:\"\"===n?\"null\":n}}};null!==t&&\"\"!==t&&(o[\":ext\"]=t);let c=\"SET transcribeVoicemail=:tv, encryptVoicemail = :ev, deliveryEmail = :de, deliveryOptions = :do\";c+=null===t||\"\"===t?\" REMOVE extension\":\", extension = :ext\";let l={Key:{agentId:e},ExpressionAttributeValues:o,UpdateExpression:c};return this.dynamo.update(l)}batchWrite(e){return this.dynamo.batchWrite(e,0)}}},11:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return r}));class r{constructor(e){this.globalRepo=e}getSettings(){return this.globalRepo.getGlobalSettings()}update(e,t,n,r){return this.globalRepo.updateGlobalSettings(e,t,n,r).then(e=>{console.log(\"Result: \"+JSON.stringify(e));let{transcribeVoicemail:t,encryptVoicemail:n,deliveryEmail:r,availableSMSCountries:s}=e.Attributes;return{transcribeVoicemail:t,encryptVoicemail:n,deliveryEmail:r,availableSMSCountries:s}})}createDefault(){return this.globalRepo.createGlobalSettings(!0,!0,process.env.DELIVERY_EMAIL)}}},12:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return l}));class r{constructor(e,t){this.userId=e.userId,this.agent=e,this.connectUser=t}}var s=n(2),i=n(5);s.a;class a extends s.a{constructor(e){super(\"ExtensionInUseError\",\"Extension already in use. Please provide a different extension number.\",\"Cannot have more than one user assigned to the extension number: \"+e)}}var o=n(9),c=n.n(o);class l{constructor(e,t){this.usersRepo=t,this.connectService=e}getConnectAgentByExtension(e){return this.usersRepo.getAgentByExtension(e).then(e=>this.connectService.getConnectUser(e.userId).then(t=>new r(e,t)))}getConnectAgentByUserId(e){return this.connectService.getConnectUser(e).then(t=>this.usersRepo.getAgentByUserId(e).then(e=>new r(e,t)))}getConnectAgents(e,t){return this.usersRepo.getAgents(e,t)}syncConnectAgents(){return Promise.all([this.connectService.listConnectUsers(),this.usersRepo.getAllAgents()]).then(e=>{let[t,n]=e,r=[];if(t.forEach(e=>{const t=n.find(t=>t.userId===e.Id);let s;t&&t.username!==e.Username?(s={...t,username:e.Username},r.push({PutRequest:this.usersRepo.createAgentCreateParam(s)})):t||(s={userId:e.Id,username:e.Username},r.push({PutRequest:this.usersRepo.createAgentCreateParam(s)}))}),n.forEach(e=>{t.find(t=>t.Id===e.userId)||r.push({DeleteRequest:this.usersRepo.createAgentDeleteParam(e)})}),r.length>0)return this.usersRepo.batchWrite(r)})}updateAgentById(e,t){return this._validateAgentUpdate(e,t).then(()=>this.createAgentIfNeeded(e,t.extension)).then(()=>this.usersRepo.updateAgentById(e,t)).then(()=>this.getConnectAgentByUserId(e))}createAgentIfNeeded(e,t){let n=this.usersRepo.getAgentByUserId(e).then(n=>null===n?this.usersRepo.createAgent(i.a.create(e,t)):n);return t?this.usersRepo.getAgentByExtension(t).then(n=>{if(null!=n&&n.userId!==e)throw new a(t);return n}).then(()=>n):n}_validateAgentUpdate(e,t){return new Promise((n,r)=>{let{extension:i,deliverSMSPhoneNumber:a,deliverSMS:o,deliverEmail:l,encryptVoicemail:u,transcribeVoicemail:d}=t;if(e)if(!0!==o||void 0!==a&&\"\"!==a){if(a){let e=new c.a(a);e.isValid()?t.deliverSMSPhoneNumber=e.getNumber():r(new s.a(\"InvalidPhoneNumberError\",\"The phone number you've entered is invalid.  Please enter a valid phone number and try again.\",\"Phone number cannot be validated for \"+a))}t.hasOwnProperty(\"extension\")&&(t.extension.length>5||Number.isNaN(t.extension))?r(new s.b(\"Invalid extension number\",\"Extension number must be numeric and less than 5 digits.\")):t.hasOwnProperty(\"extension\")&&t.hasOwnProperty(\"deliverSMS\")&&t.hasOwnProperty(\"deliverEmail\")&&t.hasOwnProperty(\"transcribeVoicemail\")&&t.hasOwnProperty(\"encryptVoicemail\")?n({agentId:e,update:t}):r(new s.d)}else r(new s.b(\"Please provide a phone number for SMS delivery\",\"deliverSMSPhoneNumber cannot be null or empty if deliverSMS is true\"));else r(new s.c(\"agentId\"))})}}},1208:function(e,t,n){\"use strict\";n.r(t);var r=n(22),s=n(12),i=n(21),a=n(27),o=n(10),c=n(13),l=n(24),u=n(25),d=n(11),h=n(14);const m=n(3),p=new o.a,g=new h.a,b=new a.a(new i.a,new s.a(new c.a,p),new r.a(new l.a,new u.a),new d.a(g));exports.stream=async(e,t)=>{let{Records:n}=e,r=n.map(async e=>{let t=e.eventName,n=m.DynamoDB.Converter.unmarshall(e.dynamodb.NewImage),r=m.DynamoDB.Converter.unmarshall(e.dynamodb.OldImage);return await b.processVoicemailRecords(t,n,r)});try{await Promise.all(r);return{lambdaResult:\"Success\"}}catch(e){return console.log(e),{error:e}}}},13:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return i}));class r{constructor(e,t=!0){this.userId=e.Id,this.arn=e.Arn,this.username=e.Username,t&&(this.firstName=e.IdentityInfo.FirstName,this.lastName=e.IdentityInfo.LastName,this.email=e.IdentityInfo.Email,e.hasOwnProperty(\"PhoneConfig\")?(this.phoneType=e.PhoneConfig.PhoneType,this.autoAccept=e.PhoneConfig.AutoAccept,this.deskPhoneNumber=e.PhoneConfig.DeskPhoneNumber):(this.phoneType=null,this.autoAccept=null,this.deskPhoneNumber=null),this.directoryUserId=e.DirectoryUserId,this.routingProfileId=e.RoutingProfileId)}getFullName(){return`${this.firstName} ${this.lastName}`}}const s=n(3);class i{constructor(){this.instanceId=process.env.AMAZON_CONNECT_INSTANCE_ARN.split(\"/\")[1],this.connect=new s.Connect,this.maxBackOffTime=45}getConnectUsers(){return this.listConnectUsers().then(e=>{let t=e.map(e=>this.getConnectUser(e.Id));return Promise.all(t)})}getConnectUser(e){return new Promise((t,n)=>{let s={InstanceId:this.instanceId,UserId:e};this.connect.describeUser(s,(e,s)=>e?(console.log(\"Error\",e),void n(e)):s?void t(new r(s.User)):(console.log(\"No user found\"),void n(e)))})}listConnectUsers(){return this._listConnectUsers([],null,0)}_listConnectUsers(e,t,n){let r={InstanceId:this.instanceId,MaxResults:1e3};return t&&(r.NextToken=t),this.connect.listUsers(r).promise().then(t=>{let{UserSummaryList:n,NextToken:r}=t,s=e.concat(n);return r?this._listConnectUsers(s,r,0):s}).catch(r=>{if(console.warn(\"list connect user failed. Retry: \"+n,r),n>5)throw r;return(s=Math.min(Math.pow(n,2),this.maxBackOffTime),new Promise(e=>setTimeout(e,s))).then(()=>this._listConnectUsers(e,t,n+1));var s})}}},14:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return i}));var r=n(4);class s{constructor(e){this.transcribeVoicemail=e.transcribeVoicemail||!1,this.encryptVoicemail=e.encryptVoicemail||!1,this.deliveryEmail=e.deliveryEmail||null,this.availableSMSCountries=e.availableSMSCountries||(process.env.AVAILABLE_SMS_COUNTRIES||\"\").split(\",\")}}class i{constructor(){this.dynamo=new r.a(process.env.GLOBAL_TABLE_NAME),this.amazonConnectInstanceArn=process.env.AMAZON_CONNECT_INSTANCE_ARN}getGlobalSettings(){console.log(\"Getting Global Settings\");let e={Key:{instanceArn:this.amazonConnectInstanceArn}};return this.dynamo.getItem(e).then(e=>e?new s(e):null)}createGlobalSettings(e,t,n,r){let i=new s({transcribeVoicemail:e,encryptVoicemail:t,deliveryEmail:n,availableSMSCountries:r});i.instanceArn=this.amazonConnectInstanceArn;let a={Item:i};return console.log(\"dynamo put\"),this.dynamo.put(a).then(()=>i)}updateGlobalSettings(e,t,n,r){return this.getGlobalSettings().then(s=>s?this._updateGlobalSettings(e,t,n,r):(console.log(\"in create\"),this.createGlobalSettings(e,t,n,r)))}_updateGlobalSettings(e,t,n,r){let s={Key:{instanceArn:this.amazonConnectInstanceArn},ExpressionAttributeValues:{\":tv\":e,\":ev\":t,\":de\":n,\":ac\":r},UpdateExpression:\"SET transcribeVoicemail=:tv, encryptVoicemail=:ev, deliveryEmail=:de, availableSMSCountries=:ac\"};return this.dynamo.update(s)}}},2:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return r})),n.d(t,\"c\",(function(){return s})),n.d(t,\"b\",(function(){return i})),n.d(t,\"d\",(function(){return a}));class r extends Error{constructor(e,t,n){super(),this.message=t,this.developerMessage=n,this.name=e}}class s extends r{constructor(e){super(\"MissingParameterError\",\"Missing parameter\",\"Missing parameter: \"+e)}}class i extends r{constructor(e,t){super(\"InvalidParameterValueError\",e,t)}}class a extends r{constructor(){super(\"MissingParametersError\",\"One or more parameters are missing\",\"You have one ore more parameters miss, please see documentation for more information.\")}}},21:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return s}));var r=n(4);class s{constructor(){this.dynamo=new r.a(process.env.CONTACT_VOICEMAIL_TABLE_NAME)}updateTranscriptionStatus(e,t,n){let r={KeyConditionExpression:\"contactId = :contactId\",ExpressionAttributeValues:{\":contactId\":e}};return Promise.all([this.dynamo.query(r)]).then(t=>{let r=[];return t[0].map(t=>{let s={Key:{contactId:e,readerId:t.readerId},ExpressionAttributeValues:{\":status\":n},UpdateExpression:\"SET transcribeStatus = :status\"};r.push(this.dynamo.update(s))}),Promise.all(r)})}}},22:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return c}));var r=n(23),s=n.n(r);const i=n(3);class a{constructor(e,t){this.transcribe=e,this.encrypt=t}}class o{constructor(e,t,n){this.transcription=e,this.preSignedUrl=t,this.audioFile=n}}class c{constructor(e,t){this.s3Service=e,this.transcriptionService=t,this.ses=new i.SES,this.sns=new i.SNS,this.transporter=s.a.createTransport({SES:this.ses}),this.recordingExpiration=parseInt(process.env.SIGNED_RECORDING_URL_EXP)}deliver(e,t,n){let r=this.getTranscribeAndEncryptionSettings(e,t),s=n.agent.deliveryOptions,i=s.email,a=s.sms.enabled,o=n.connectUser.email||n.connectUser.username,c=s.sms.phoneNumber,l=e.deliveryEmail;if(!l)throw\"You must provide a delivery email\";return i||a?i&&a?(console.log(\"Should Send BOTH email and SMS\"),this.getDeliveryContents(r,t).then(e=>this.sendTextMessage(t,c,e).then(()=>this.sendMail(t,l,o,e)))):a&&c?(console.log(\"Send ONLY SMS\"),this.getDeliveryContents(r,t).then(e=>this.sendTextMessage(t,c,e))):s.email?(console.log(\"Send ONLY Email\"),this.getDeliveryContents(r,t).then(e=>this.sendMail(t,l,o,e))):Promise.resolve({message:\"Undeliverable\"}):(console.log(\"NOT sending email or sms\"),Promise.resolve({message:\"Not sending Email or SNS\"}))}getDeliveryContents(e,t){console.log(\"Getting Delivery Contents\");let n=Promise.resolve(null),r=Promise.resolve(null),s=Promise.resolve(null);if(e.encrypt?(console.log(\"Encrypt...\"),r=this.s3Service.getPreSignedUrl(t.recordingBucketName,t.recordingObjectKey,this.recordingExpiration)):(console.log(\"Unencrypted...\"),s=this.s3Service.getFile(t.recordingBucketName,t.recordingObjectKey)),e.transcribe){console.log(\"Transcribe...\");let e=t.getTranscriptJobName();n=this.transcriptionService.getTranscriptForJobName(e)}return Promise.all([n,r,s]).then(e=>{let t=e[0],n=e[1],r=e[2];return new o(t,n,r)})}sendMail(e,t,n,r){return new Promise((s,i)=>{let a=`<p>${new Date(1e3*e.timestamp)}</p>`;if(a+=`<p>New voicemail from ${e.contactPhoneNumber}.</p>`,r.transcription&&(a+=`<b>Voicemail Transcript:</b><p>${r.transcription.transcripts[0].transcript}</p>`),a+=\"<b>Voicemail:</b>\",r.preSignedUrl){a+=`<p>Voicemail Expiration Date: ${new Date(1e3*Math.floor(Date.now()/1e3+r.preSignedUrl.expires))}</p>`,a+=`<p><a href=\"${r.preSignedUrl.url}\">Click Here</a> to listen to the voicemail</p>`}let o={from:t,subject:\"New voicemail from \"+e.contactPhoneNumber,html:a,to:n};r.audioFile&&(o.attachments=[{filename:\"voicemail.wav\",content:r.audioFile.Body}]),this.transporter.sendMail(o,(e,t)=>{if(e)return console.log(e),void i(e);s(t)})})}sendTextMessage(e,t,n){return new Promise((r,s)=>{let i=`Amazon Connect voicemail from ${e.contactPhoneNumber}\\n`;if(n.transcription&&(i+=`\\nTranscript: \"${n.transcription.transcripts[0].transcript}\"\\n`),n.preSignedUrl){i+=`\\nVoicemail Expiration Date: ${new Date(1e3*Math.floor(Date.now()/1e3+n.preSignedUrl.expires))}\\n`,i+=\"\"+n.preSignedUrl.url}let a={Message:i,PhoneNumber:t};this.sns.publish(a,(e,t)=>{e&&console.log(\"Error: \"+e),r(t)})})}getTranscribeAndEncryptionSettings(e,t){let n=!1,r=!0;return!0===e.transcribeVoicemail&&(n=t.shouldTranscribe),!1===e.encryptVoicemail&&(r=t.shouldEncrypt),new a(n,r)}}},23:function(e,t){e.exports=require(\"nodemailer\")},24:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return s}));const r=n(3);class s{constructor(){this.secretsManager=new r.SecretsManager;const e=async()=>await this.secretsManager.getSecretValue({SecretId:process.env.SECRET_ARN}).promise().then(e=>e).catch(e=>(console.log(\"error \",e),e));(async()=>{const t=await e();if(this.isTempToken=!1,\"SecretString\"in t){var n=t.SecretString,s=JSON.parse(n),i=s.accessKeyId,a=s.secretAccessKey;this.s3=new r.S3({signatureVersion:\"v4\",credentials:{secretAccessKey:a,accessKeyId:i}})}else this.isTempToken=!0,this.s3=new r.S3})()}getFile(e,t){let n={Bucket:e,Key:t};return this.s3.getObject(n).promise()}getPreSignedUrl(e,t,n=900){return new Promise((r,s)=>{this.isTempToken?n>43200&&(console.log(\"Could not create a presigned URL valid for greater than 12 hours because there was an error while retrieving the IAM User Access Key credentials from the AWS Secrets Manager (please refer to CloudWatch Logs for details). So creating a presigned URL valid up to 12 hours using temporary credentials of Lambda IAM Role.\"),n=43200):console.log(\"Creating a pre-signed URL valid up to \"+n+\" seconds using IAM User Access Key.\");let i={Bucket:e,Key:t,Expires:n};return this.s3.getSignedUrl(\"getObject\",i,(e,t)=>{e?s(e):r({url:t,expires:n})})})}}},25:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return a}));var r=n(26),s=n.n(r);const i=n(3);class a{constructor(){this.transcribe=new i.TranscribeService}getTranscriptForJobName(e){let t={TranscriptionJobName:e};return this.transcribe.getTranscriptionJob(t).promise().then(e=>{let t={method:\"GET\",uri:e.TranscriptionJob.Transcript.TranscriptFileUri,json:!0};return s()(t).then(t=>({transcriptionJob:e,transcripts:t.results.transcripts||null}))}).catch(e=>{console.log(e)})}}},26:function(e,t){e.exports=require(\"request-promise\")},27:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return s}));class r{constructor(e){this.contactId=e.contactId,this.timestamp=e.timestamp,this.agentId=e.readerId,this.contactPhoneNumber=e.contactPhoneNumber,this.shouldTranscribe=e.shouldTranscribe||!1,this.shouldEncrypt=e.shouldEncrypt||!1,this.transcribeStatus=e.transcribeStatus,this.recordingUrl=e.recordingUrl,this.recordingBucketName=e.recordingBucketName,this.recordingObjectKey=e.recordingObjectKey,this.recordingBucketRegion=e.recordingBucketRegion}getTranscriptJobName(){return`${this.contactId}_${this.timestamp}`}}class s{constructor(e,t,n,r){this.voicemailRepo=e,this.agentService=t,this.notificationService=n,this.globalSettingsService=r}updateVoicemailTranscriptStatus(e,t){let n=e.split(\"_\"),r=n[0],s=parseInt(n[1]);return this.voicemailRepo.updateTranscriptionStatus(r,s,t)}processVoicemailRecords(e,t,n){console.log(\"Processing Voicemail Recording\");let s=new r(t);return\"IN_PROGRESS\"===new r(n).transcribeStatus&&\"COMPLETED\"===s.transcribeStatus||null===s.transcribeStatus||void 0===s.transcribeStatus?this._deliver(s):Promise.resolve({message:\"Unhandled Resolution\"})}_deliver(e){return Promise.all([this.globalSettingsService.getSettings(),this.agentService.getConnectAgentByUserId(e.agentId)]).then(t=>{let n=t[0],r=t[1];return this.notificationService.deliver(n,e,r)})}}},3:function(e,t){e.exports=require(\"aws-sdk\")},4:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return s}));const r=n(3);class s{constructor(e){this.tableName=e,this.client=new r.DynamoDB.DocumentClient}update(e){return e.TableName=this.tableName,e.ReturnValues=\"ALL_NEW\",this.client.update(e).promise()}put(e){return e.TableName=this.tableName,this.client.put(e).promise()}query(e){return e.TableName=this.tableName,this.client.query(e).promise().then(e=>e.Items||null)}scan(e,t=[]){return e.TableName=this.tableName,this.client.scan(e).promise().then(n=>{let r=t;return n.Items&&(r=t.concat(n.Items)),n.LastEvaluatedKey?(console.log(\"Rescanning with next page\"),e.ExclusiveStartKey=n.LastEvaluatedKey,this.scan(e,r)):r})}queryWithNext(e){return e.TableName=this.tableName,this.client.query(e).promise().then(e=>{let t={data:e.Items||[]};return e.LastEvaluatedKey&&(t.next=Buffer.from(JSON.stringify(e.LastEvaluatedKey),\"utf8\").toString(\"base64\")),t})}scanWithNext(e){return e.TableName=this.tableName,this.client.scan(e).promise().then(e=>{let t={data:e.Items||[]};return e.LastEvaluatedKey&&(t.next=Buffer.from(JSON.stringify(e.LastEvaluatedKey),\"utf8\").toString(\"base64\")),t})}getItem(e,t){return e.TableName=this.tableName,this.client.get(e).promise().then(e=>e.Item||null)}batchWrite(e,t){return new Promise((n,r)=>{this._batchWrite(e,t).then(t=>{e.length>t.index?this.batchWrite(e,t.index).then(e=>{n(e)}):n(t.data)})})}_batchWrite(e,t){return new Promise((n,r)=>{let s=e.length>t+24?t+24:e.length,i=e.slice(t,s),a={RequestItems:{[this.tableName]:i}};this.client.batchWrite(a,(e,r)=>{e&&console.log(\"Any error? \"+JSON.stringify(e,null,2)),n({index:t+24,data:r})})})}}},5:function(e,t,n){\"use strict\";n.d(t,\"a\",(function(){return r}));class r{constructor(e){this.userId=e.userId,this.extension=e.extension,this.username=e.username,this.transcribeVoicemail=e.transcribeVoicemail||!1,this.encryptVoicemail=e.encryptVoicemail||!1,this.deliveryOptions=e.deliveryOptions||{sms:{enabled:!1,phoneNumber:null},email:!1}}static create(e,t=null){return new r({userId:e,extension:t,deliveryOptions:{sms:{enabled:!1,phoneNumber:null},email:!1}})}}},9:function(e,t){e.exports=require(\"awesome-phonenumber\")}}));","extractedComments":[]}