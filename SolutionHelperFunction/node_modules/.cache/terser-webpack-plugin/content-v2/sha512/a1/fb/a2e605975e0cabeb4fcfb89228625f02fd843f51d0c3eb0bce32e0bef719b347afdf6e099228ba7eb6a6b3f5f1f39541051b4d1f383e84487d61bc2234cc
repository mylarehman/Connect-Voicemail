{"map":"{\"version\":3,\"sources\":[\"authorizer.js\"],\"names\":[\"e\",\"a\",\"i\",\"exports\",\"modules\",\"installedModules\",\"__webpack_require__\",\"moduleId\",\"module\",\"l\",\"call\",\"m\",\"c\",\"d\",\"name\",\"getter\",\"o\",\"Object\",\"defineProperty\",\"enumerable\",\"get\",\"r\",\"Symbol\",\"toStringTag\",\"value\",\"t\",\"mode\",\"__esModule\",\"ns\",\"create\",\"key\",\"bind\",\"n\",\"object\",\"property\",\"prototype\",\"hasOwnProperty\",\"p\",\"s\",\"1209\",\"__webpack_exports__\",\"AwsApiGatewayResource\",\"[object Object]\",\"resource\",\"resourceComponents\",\"split\",\"apiGatewayArnTmp\",\"this\",\"accountId\",\"region\",\"restApiId\",\"stage\",\"apiOptions\",\"pathComponents\",\"AuthPolicy\",\"principal\",\"awsAccountId\",\"principalId\",\"version\",\"pathRegex\",\"RegExp\",\"allowMethods\",\"denyMethods\",\"HttpVerb\",\"GET\",\"POST\",\"PUT\",\"PATCH\",\"HEAD\",\"DELETE\",\"OPTIONS\",\"ALL\",\"addMethod\",\"effect\",\"verb\",\"conditions\",\"Error\",\"test\",\"cleanedResource\",\"substring\",\"length\",\"resourceArn\",\"toLowerCase\",\"push\",\"getEmptyStatement\",\"toUpperCase\",\"statement\",\"Action\",\"Effect\",\"Resource\",\"getStatementsForEffect\",\"methods\",\"statements\",\"curMethod\",\"conditionalStatement\",\"Condition\",\"constructor\",\"denyPolicy\",\"context\",\"console\",\"log\",\"policy\",\"conext\",\"denyPolicyStatementWithContext\",\"allowAllMethods\",\"denyAllMethods\",\"allowMethod\",\"denyMethod\",\"allowMethodWithConditions\",\"denyMethodWithConditions\",\"build\",\"doc\",\"Version\",\"Statement\",\"concat\",\"policyDocument\",\"external_node_jose_\",\"external_node_jose_default\",\"external_https_\",\"external_https_default\",\"auth_service_AuthService\",\"userPoolId\",\"keysUrl\",\"process\",\"env\",\"APP_REGION\",\"authorizationToken\",\"methodArn\",\"Promise\",\"resolve\",\"reason\",\"claims\",\"token\",\"trim\",\"jwtSplit\",\"kid\",\"JSON\",\"parse\",\"util\",\"base64url\",\"decode\",\"verifyKey\",\"then\",\"verifyAndGeneratePolicy\",\"claimResults\",\"username\",\"_generate\",\"roles\",\"reject\",\"response\",\"statusCode\",\"on\",\"body\",\"keys\",\"keyIndex\",\"error\",\"JWK\",\"asKey\",\"result\",\"JWS\",\"createVerify\",\"verify\",\"payload\",\"Math\",\"floor\",\"Date\",\"exp\",\"err\",\"isAdmin\",\"includes\",\"isManager\",\"gatewayResource\",\"parseApiGatewayResource\",\"policyResponse\",\"_build\",\"authResponse\",\"statementOne\",\"handler\",\"event\",\"callback\",\"authService\",\"COGNITO_USER_POOL_ID\",\"validateAndGeneratePolicy\",\"catch\",\"31\",\"require\",\"8\"],\"mappings\":\"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\"}","code":"!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,\"a\",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p=\"\",n(n.s=1209)}({1209:function(e,t,n){\"use strict\";n.r(t);class o{constructor(e){let t=e.split(\":\"),n=t[5].split(\"/\");this.accountId=t[4],this.region=t[3],this.restApiId=n[0],this.stage=n[1],this.apiOptions={region:this.region,restApiId:this.restApiId,stage:this.stage},this.pathComponents=n}}function r(e,t,n){this.awsAccountId=t,this.principalId=e,this.version=\"2012-10-17\",this.pathRegex=new RegExp(\"^[/.a-zA-Z0-9-*]+$\"),this.allowMethods=[],this.denyMethods=[],n&&n.restApiId?this.restApiId=n.restApiId:this.restApiId=\"*\",n&&n.region?this.region=n.region:this.region=\"*\",n&&n.stage?this.stage=n.stage:this.stage=\"*\"}r.HttpVerb={GET:\"GET\",POST:\"POST\",PUT:\"PUT\",PATCH:\"PATCH\",HEAD:\"HEAD\",DELETE:\"DELETE\",OPTIONS:\"OPTIONS\",ALL:\"*\"},r.prototype=function(){let e=function(e,t,n,o){if(\"*\"!==t&&!r.HttpVerb.hasOwnProperty(t))throw new Error(\"Invalid HTTP verb \"+t+\". Allowed verbs in AuthPolicy.HttpVerb\");if(!this.pathRegex.test(n))throw new Error(\"Invalid resource path: \"+n+\". Path should match \"+this.pathRegex);let i=n;\"/\"===n.substring(0,1)&&(i=n.substring(1,n.length));let s=\"arn:aws:execute-api:\"+this.region+\":\"+this.awsAccountId+\":\"+this.restApiId+\"/\"+this.stage+\"/\"+t+\"/\"+i;\"allow\"===e.toLowerCase()?this.allowMethods.push({resourceArn:s,conditions:o}):\"deny\"===e.toLowerCase()&&this.denyMethods.push({resourceArn:s,conditions:o})},t=function(e){e=e.substring(0,1).toUpperCase()+e.substring(1,e.length).toLowerCase();let t={Action:\"execute-api:Invoke\"};return t.Effect=e,t.Resource=[],t},n=function(e,n){let o=[];if(n.length>0){let r=t(e);for(let i=0;i<n.length;i++){let s=n[i];if(null===s.conditions||0===s.conditions.length)r.Resource.push(s.resourceArn);else{let n=t(e);n.Resource.push(s.resourceArn),n.Condition=s.conditions,o.push(n)}}null!==r.Resource&&r.Resource.length>0&&o.push(r)}return o};return{constructor:r,denyPolicy:function(e){return function(e){console.log(\"Creating deny\");let n=t(\"Deny\");return n.conext={...e},n}(e)},allowAllMethods:function(){e.call(this,\"allow\",\"*\",\"*\",null)},denyAllMethods:function(){e.call(this,\"deny\",\"*\",\"*\",null)},allowMethod:function(t,n){e.call(this,\"allow\",t,n,null)},denyMethod:function(t,n){e.call(this,\"deny\",t,n,null)},allowMethodWithConditions:function(t,n,o){e.call(this,\"allow\",t,n,o)},denyMethodWithConditions:function(t,n,o){e.call(this,\"deny\",t,n,o)},build:function(){if(!(this.allowMethods&&0!==this.allowMethods.length||this.denyMethods&&0!==this.denyMethods.length))throw new Error(\"No statements defined for the policy\");let e={};e.principalId=this.principalId;let t={};return t.Version=this.version,t.Statement=[],t.Statement=t.Statement.concat(n.call(this,\"Allow\",this.allowMethods)),t.Statement=t.Statement.concat(n.call(this,\"Deny\",this.denyMethods)),e.policyDocument=t,e}}}();var i=n(31),s=n.n(i),l=n(8),a=n.n(l);class c{constructor(e){this.keysUrl=\"https://cognito-idp.\"+process.env.APP_REGION+\".amazonaws.com/\"+e+\"/.well-known/jwks.json\"}validateAndGeneratePolicy(e,t){if(void 0===e)return console.log(\"No Token found\"),Promise.resolve({effect:\"deny\",reason:\"No auth token\",claims:null});{const n=e.split(\"Bearer\");if(2!==n.length)return console.log(\"No token in Bearer\"),Promise.resolve({effect:\"deny\",reason:\"No token in Bearer\",claims:null});const o=n[1].trim();let r=o.split(\".\"),i=JSON.parse(s.a.util.base64url.decode(r[0])).kid;return this.verifyKey(i,o,this.keysUrl).then(e=>this.verifyAndGeneratePolicy(e,t))}}verifyAndGeneratePolicy(e,t){if(!e)throw\"Invalid claim\";let{claims:n,effect:o,reason:r}=e,i=n[\"cognito:username\"];if(o)return this._generate(i,o,t,n,{reason:r,roles:n[\"custom:roles\"]});throw\"Invalid Token\"}verifyKey(e,t,n){return new Promise((o,r)=>{a.a.get(n,n=>{200===n.statusCode?n.on(\"data\",n=>{let i=JSON.parse(n).keys,l=-1;for(let t=0;t<i.length;t++)if(e===i[t].kid){l=t;break}if(-1===l)return console.error(\"No public key\"),void o({effect:\"deny\",reason:\"No public key\",claims:null});s.a.JWK.asKey(i[l]).then(e=>{s.a.JWS.createVerify(e).verify(t).then(e=>{let t=JSON.parse(e.payload);Math.floor(new Date/1e3)>t.exp?o({effect:\"deny\",reason:\"Token expired\",claims:t}):o({effect:\"allow\",reason:\"Verified\",claims:t})},e=>{r(e)})},e=>{r(e)})}):r(new Error(\"Key Unverified\"))})})}_generate(e,t,n,i,s={}){let l=i[\"cognito:groups\"],a=l.includes(\"Admin\"),c=l.includes(\"Manager\"),u=class{static parseApiGatewayResource(e){return new o(e)}}.parseApiGatewayResource(n),h=new r(e,u.accountId,u.apiOptions);if(\"allow\"===t.toLowerCase()){a||c?h.allowAllMethods():h.denyAllMethods();let e=h.build();return s&&(e.context={...s}),e}return this._build(e,t,n,i,s)}_build(e,t,n,o,r={}){let i={};if(i.principalId=e,t&&n){let e={Version:\"2012-10-17\",Statement:[]},o={Action:\"execute-api:Invoke\"};o.Effect=\"allow\"===t.toLowerCase()?\"Allow\":\"Deny\",o.Resource=n,e.Statement[0]=o,i.policyDocument=e}return i.context={...r},i}}exports.handler=(e,t,n)=>{let o=new c(process.env.COGNITO_USER_POOL_ID);console.log(e.authorizationToken,e.methodArn),o.validateAndGeneratePolicy(e.authorizationToken,e.methodArn).then(e=>{console.log(e),n(null,e)}).catch(e=>{console.log(\"Error\",e),n(\"Unauthorized \"+e)})}},31:function(e,t){e.exports=require(\"node-jose\")},8:function(e,t){e.exports=require(\"https\")}}));","extractedComments":[]}