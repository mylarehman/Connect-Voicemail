!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1209)}({1209:function(e,t,n){"use strict";n.r(t);class o{constructor(e){let t=e.split(":"),n=t[5].split("/");this.accountId=t[4],this.region=t[3],this.restApiId=n[0],this.stage=n[1],this.apiOptions={region:this.region,restApiId:this.restApiId,stage:this.stage},this.pathComponents=n}}function r(e,t,n){this.awsAccountId=t,this.principalId=e,this.version="2012-10-17",this.pathRegex=new RegExp("^[/.a-zA-Z0-9-*]+$"),this.allowMethods=[],this.denyMethods=[],n&&n.restApiId?this.restApiId=n.restApiId:this.restApiId="*",n&&n.region?this.region=n.region:this.region="*",n&&n.stage?this.stage=n.stage:this.stage="*"}r.HttpVerb={GET:"GET",POST:"POST",PUT:"PUT",PATCH:"PATCH",HEAD:"HEAD",DELETE:"DELETE",OPTIONS:"OPTIONS",ALL:"*"},r.prototype=function(){let e=function(e,t,n,o){if("*"!==t&&!r.HttpVerb.hasOwnProperty(t))throw new Error("Invalid HTTP verb "+t+". Allowed verbs in AuthPolicy.HttpVerb");if(!this.pathRegex.test(n))throw new Error("Invalid resource path: "+n+". Path should match "+this.pathRegex);let i=n;"/"===n.substring(0,1)&&(i=n.substring(1,n.length));let s="arn:aws:execute-api:"+this.region+":"+this.awsAccountId+":"+this.restApiId+"/"+this.stage+"/"+t+"/"+i;"allow"===e.toLowerCase()?this.allowMethods.push({resourceArn:s,conditions:o}):"deny"===e.toLowerCase()&&this.denyMethods.push({resourceArn:s,conditions:o})},t=function(e){e=e.substring(0,1).toUpperCase()+e.substring(1,e.length).toLowerCase();let t={Action:"execute-api:Invoke"};return t.Effect=e,t.Resource=[],t},n=function(e,n){let o=[];if(n.length>0){let r=t(e);for(let i=0;i<n.length;i++){let s=n[i];if(null===s.conditions||0===s.conditions.length)r.Resource.push(s.resourceArn);else{let n=t(e);n.Resource.push(s.resourceArn),n.Condition=s.conditions,o.push(n)}}null!==r.Resource&&r.Resource.length>0&&o.push(r)}return o};return{constructor:r,denyPolicy:function(e){return function(e){console.log("Creating deny");let n=t("Deny");return n.conext={...e},n}(e)},allowAllMethods:function(){e.call(this,"allow","*","*",null)},denyAllMethods:function(){e.call(this,"deny","*","*",null)},allowMethod:function(t,n){e.call(this,"allow",t,n,null)},denyMethod:function(t,n){e.call(this,"deny",t,n,null)},allowMethodWithConditions:function(t,n,o){e.call(this,"allow",t,n,o)},denyMethodWithConditions:function(t,n,o){e.call(this,"deny",t,n,o)},build:function(){if(!(this.allowMethods&&0!==this.allowMethods.length||this.denyMethods&&0!==this.denyMethods.length))throw new Error("No statements defined for the policy");let e={};e.principalId=this.principalId;let t={};return t.Version=this.version,t.Statement=[],t.Statement=t.Statement.concat(n.call(this,"Allow",this.allowMethods)),t.Statement=t.Statement.concat(n.call(this,"Deny",this.denyMethods)),e.policyDocument=t,e}}}();var i=n(31),s=n.n(i),l=n(8),a=n.n(l);class c{constructor(e){this.keysUrl="https://cognito-idp."+process.env.APP_REGION+".amazonaws.com/"+e+"/.well-known/jwks.json"}validateAndGeneratePolicy(e,t){if(void 0===e)return console.log("No Token found"),Promise.resolve({effect:"deny",reason:"No auth token",claims:null});{const n=e.split("Bearer");if(2!==n.length)return console.log("No token in Bearer"),Promise.resolve({effect:"deny",reason:"No token in Bearer",claims:null});const o=n[1].trim();let r=o.split("."),i=JSON.parse(s.a.util.base64url.decode(r[0])).kid;return this.verifyKey(i,o,this.keysUrl).then(e=>this.verifyAndGeneratePolicy(e,t))}}verifyAndGeneratePolicy(e,t){if(!e)throw"Invalid claim";let{claims:n,effect:o,reason:r}=e,i=n["cognito:username"];if(o)return this._generate(i,o,t,n,{reason:r,roles:n["custom:roles"]});throw"Invalid Token"}verifyKey(e,t,n){return new Promise((o,r)=>{a.a.get(n,n=>{200===n.statusCode?n.on("data",n=>{let i=JSON.parse(n).keys,l=-1;for(let t=0;t<i.length;t++)if(e===i[t].kid){l=t;break}if(-1===l)return console.error("No public key"),void o({effect:"deny",reason:"No public key",claims:null});s.a.JWK.asKey(i[l]).then(e=>{s.a.JWS.createVerify(e).verify(t).then(e=>{let t=JSON.parse(e.payload);Math.floor(new Date/1e3)>t.exp?o({effect:"deny",reason:"Token expired",claims:t}):o({effect:"allow",reason:"Verified",claims:t})},e=>{r(e)})},e=>{r(e)})}):r(new Error("Key Unverified"))})})}_generate(e,t,n,i,s={}){let l=i["cognito:groups"],a=l.includes("Admin"),c=l.includes("Manager"),u=class{static parseApiGatewayResource(e){return new o(e)}}.parseApiGatewayResource(n),h=new r(e,u.accountId,u.apiOptions);if("allow"===t.toLowerCase()){a||c?h.allowAllMethods():h.denyAllMethods();let e=h.build();return s&&(e.context={...s}),e}return this._build(e,t,n,i,s)}_build(e,t,n,o,r={}){let i={};if(i.principalId=e,t&&n){let e={Version:"2012-10-17",Statement:[]},o={Action:"execute-api:Invoke"};o.Effect="allow"===t.toLowerCase()?"Allow":"Deny",o.Resource=n,e.Statement[0]=o,i.policyDocument=e}return i.context={...r},i}}exports.handler=(e,t,n)=>{let o=new c(process.env.COGNITO_USER_POOL_ID);console.log(e.authorizationToken,e.methodArn),o.validateAndGeneratePolicy(e.authorizationToken,e.methodArn).then(e=>{console.log(e),n(null,e)}).catch(e=>{console.log("Error",e),n("Unauthorized "+e)})}},31:function(e,t){e.exports=require("node-jose")},8:function(e,t){e.exports=require("https")}}));
//# sourceMappingURL=authorizer.js.map