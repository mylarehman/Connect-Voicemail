!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1206)}({10:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var s=n(4),r=n(5);class i{constructor(){this.dynamo=new s.a(process.env.USERS_TABLE_NAME),this.amazonConnectInstanceId=process.env.AMAZON_CONNECT_INSTANCE_ARN}getAgentByExtension(e){let t={IndexName:"AgentExtensionIndex",KeyConditionExpression:"extension = :ext",ExpressionAttributeValues:{":ext":e}};return this.dynamo.query(t).then(e=>e.length>0?new r.a(e[0]):null)}getAgentByUserId(e){let t={Key:{agentId:e}};return this.dynamo.getItem(t).then(e=>e?new r.a(e):null)}getAgents(e,t){let n={Limit:t||1e3,Select:"ALL_ATTRIBUTES"};return e&&(n.ExclusiveStartKey=JSON.parse(Buffer.from(e,"base64").toString("utf-8"))),this.dynamo.scanWithNext(n)}getAllAgents(){return this.dynamo.scan({Select:"ALL_ATTRIBUTES"})}createAgentCreateParam(e){let t={Item:{...e,agentId:e.userId}};return""===e.extension&&delete t.Item.extension,t}createAgentDeleteParam(e){return{Key:{agentId:e.userId}}}createAgent(e){let t=this.createAgentData(e);return this.dynamo.put(t)}updateAgentById(e,{extension:t,deliverSMSPhoneNumber:n,deliverSMS:s,deliverEmail:r,encryptVoicemail:i,transcribeVoicemail:o}){let a={":tv":o||!1,":ev":i||!1,":de":r,":do":{email:r,sms:{enabled:s,phoneNumber:""===n?"null":n}}};null!==t&&""!==t&&(a[":ext"]=t);let u="SET transcribeVoicemail=:tv, encryptVoicemail = :ev, deliveryEmail = :de, deliveryOptions = :do";u+=null===t||""===t?" REMOVE extension":", extension = :ext";let c={Key:{agentId:e},ExpressionAttributeValues:a,UpdateExpression:u};return this.dynamo.update(c)}batchWrite(e){return this.dynamo.batchWrite(e,0)}}},12:function(e,t,n){"use strict";n.d(t,"a",(function(){return c}));class s{constructor(e,t){this.userId=e.userId,this.agent=e,this.connectUser=t}}var r=n(2),i=n(5);r.a;class o extends r.a{constructor(e){super("ExtensionInUseError","Extension already in use. Please provide a different extension number.","Cannot have more than one user assigned to the extension number: "+e)}}var a=n(9),u=n.n(a);class c{constructor(e,t){this.usersRepo=t,this.connectService=e}getConnectAgentByExtension(e){return this.usersRepo.getAgentByExtension(e).then(e=>this.connectService.getConnectUser(e.userId).then(t=>new s(e,t)))}getConnectAgentByUserId(e){return this.connectService.getConnectUser(e).then(t=>this.usersRepo.getAgentByUserId(e).then(e=>new s(e,t)))}getConnectAgents(e,t){return this.usersRepo.getAgents(e,t)}syncConnectAgents(){return Promise.all([this.connectService.listConnectUsers(),this.usersRepo.getAllAgents()]).then(e=>{let[t,n]=e,s=[];if(t.forEach(e=>{const t=n.find(t=>t.userId===e.Id);let r;t&&t.username!==e.Username?(r={...t,username:e.Username},s.push({PutRequest:this.usersRepo.createAgentCreateParam(r)})):t||(r={userId:e.Id,username:e.Username},s.push({PutRequest:this.usersRepo.createAgentCreateParam(r)}))}),n.forEach(e=>{t.find(t=>t.Id===e.userId)||s.push({DeleteRequest:this.usersRepo.createAgentDeleteParam(e)})}),s.length>0)return this.usersRepo.batchWrite(s)})}updateAgentById(e,t){return this._validateAgentUpdate(e,t).then(()=>this.createAgentIfNeeded(e,t.extension)).then(()=>this.usersRepo.updateAgentById(e,t)).then(()=>this.getConnectAgentByUserId(e))}createAgentIfNeeded(e,t){let n=this.usersRepo.getAgentByUserId(e).then(n=>null===n?this.usersRepo.createAgent(i.a.create(e,t)):n);return t?this.usersRepo.getAgentByExtension(t).then(n=>{if(null!=n&&n.userId!==e)throw new o(t);return n}).then(()=>n):n}_validateAgentUpdate(e,t){return new Promise((n,s)=>{let{extension:i,deliverSMSPhoneNumber:o,deliverSMS:a,deliverEmail:c,encryptVoicemail:l,transcribeVoicemail:d}=t;if(e)if(!0!==a||void 0!==o&&""!==o){if(o){let e=new u.a(o);e.isValid()?t.deliverSMSPhoneNumber=e.getNumber():s(new r.a("InvalidPhoneNumberError","The phone number you've entered is invalid.  Please enter a valid phone number and try again.","Phone number cannot be validated for "+o))}t.hasOwnProperty("extension")&&(t.extension.length>5||Number.isNaN(t.extension))?s(new r.b("Invalid extension number","Extension number must be numeric and less than 5 digits.")):t.hasOwnProperty("extension")&&t.hasOwnProperty("deliverSMS")&&t.hasOwnProperty("deliverEmail")&&t.hasOwnProperty("transcribeVoicemail")&&t.hasOwnProperty("encryptVoicemail")?n({agentId:e,update:t}):s(new r.d)}else s(new r.b("Please provide a phone number for SMS delivery","deliverSMSPhoneNumber cannot be null or empty if deliverSMS is true"));else s(new r.c("agentId"))})}}},1206:function(e,t,n){"use strict";n.r(t);n(32);var s=n(12),r=n(13),i=n(10),o=n(6),a=n(20);const u=new s.a(new r.a,new i.a);function c(e,t){"true"==process.env.SEND_ANON_DATA&&a.Metrics.sendAnonymousData({uuid:process.env.UUID,process:"sync",status:e,details:t||""}).catch(e=>console.log("sendAnonymous: "+e.message))}exports.syncHandler=(e,t)=>u.syncConnectAgents().then(e=>{c("Success")}).catch(e=>{c("Failure",o.a.Error(400,e,"Unable to sync agents",!0))}),exports.syncRequestHandler=(e,t)=>u.syncConnectAgents().then(e=>(c("Success"),o.a.Response(200,{},!0))).catch(e=>{console.log("returning a 400: "+JSON.stringify(e));let t=o.a.Error(400,e,"Unable to sync agents",!0);return c("Failure",t),t})},13:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));class s{constructor(e,t=!0){this.userId=e.Id,this.arn=e.Arn,this.username=e.Username,t&&(this.firstName=e.IdentityInfo.FirstName,this.lastName=e.IdentityInfo.LastName,this.email=e.IdentityInfo.Email,e.hasOwnProperty("PhoneConfig")?(this.phoneType=e.PhoneConfig.PhoneType,this.autoAccept=e.PhoneConfig.AutoAccept,this.deskPhoneNumber=e.PhoneConfig.DeskPhoneNumber):(this.phoneType=null,this.autoAccept=null,this.deskPhoneNumber=null),this.directoryUserId=e.DirectoryUserId,this.routingProfileId=e.RoutingProfileId)}getFullName(){return`${this.firstName} ${this.lastName}`}}const r=n(3);class i{constructor(){this.instanceId=process.env.AMAZON_CONNECT_INSTANCE_ARN.split("/")[1],this.connect=new r.Connect,this.maxBackOffTime=45}getConnectUsers(){return this.listConnectUsers().then(e=>{let t=e.map(e=>this.getConnectUser(e.Id));return Promise.all(t)})}getConnectUser(e){return new Promise((t,n)=>{let r={InstanceId:this.instanceId,UserId:e};this.connect.describeUser(r,(e,r)=>e?(console.log("Error",e),void n(e)):r?void t(new s(r.User)):(console.log("No user found"),void n(e)))})}listConnectUsers(){return this._listConnectUsers([],null,0)}_listConnectUsers(e,t,n){let s={InstanceId:this.instanceId,MaxResults:1e3};return t&&(s.NextToken=t),this.connect.listUsers(s).promise().then(t=>{let{UserSummaryList:n,NextToken:s}=t,r=e.concat(n);return s?this._listConnectUsers(r,s,0):r}).catch(s=>{if(console.warn("list connect user failed. Retry: "+n,s),n>5)throw s;return(r=Math.min(Math.pow(n,2),this.maxBackOffTime),new Promise(e=>setTimeout(e,r))).then(()=>this._listConnectUsers(e,t,n+1));var r})}}},2:function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"c",(function(){return r})),n.d(t,"b",(function(){return i})),n.d(t,"d",(function(){return o}));class s extends Error{constructor(e,t,n){super(),this.message=t,this.developerMessage=n,this.name=e}}class r extends s{constructor(e){super("MissingParameterError","Missing parameter","Missing parameter: "+e)}}class i extends s{constructor(e,t){super("InvalidParameterValueError",e,t)}}class o extends s{constructor(){super("MissingParametersError","One or more parameters are missing","You have one ore more parameters miss, please see documentation for more information.")}}},20:function(e,t,n){const s=n(8);class r{static get Constants(){return{Host:"metrics.awssolutionsbuilder.com",Path:"/generic"}}static async sendAnonymousData(e,t){return new Promise((n,i)=>{const o=Object.assign({Solution:process.env.SOLUTION_ID,UUID:process.env.UUID,TimeStamp:(new Date).toISOString().replace("T"," ").replace("Z",""),Data:e},t);o.Data&&o.Solution&&o.UUID||n(void 0);const a=[],u={hostname:r.Constants.Host,port:443,path:r.Constants.Path,method:"POST",headers:{"Content-Type":"application/json"}},c=s.request(u,e=>{e.on("data",e=>a.push(e)),e.on("end",()=>{e.statusCode>=400?i(new Error(`${e.statusCode} ${e.statusMessage} ${u.hostname}`)):n(Buffer.concat(a))})});c.write(JSON.stringify(o)),c.on("error",e=>i(e)),c.end(),console.log("successfully sent metrics")})}}e.exports={Metrics:r}},3:function(e,t){e.exports=require("aws-sdk")},32:function(e,t){e.exports=require("source-map-support/register")},4:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));const s=n(3);class r{constructor(e){this.tableName=e,this.client=new s.DynamoDB.DocumentClient}update(e){return e.TableName=this.tableName,e.ReturnValues="ALL_NEW",this.client.update(e).promise()}put(e){return e.TableName=this.tableName,this.client.put(e).promise()}query(e){return e.TableName=this.tableName,this.client.query(e).promise().then(e=>e.Items||null)}scan(e,t=[]){return e.TableName=this.tableName,this.client.scan(e).promise().then(n=>{let s=t;return n.Items&&(s=t.concat(n.Items)),n.LastEvaluatedKey?(console.log("Rescanning with next page"),e.ExclusiveStartKey=n.LastEvaluatedKey,this.scan(e,s)):s})}queryWithNext(e){return e.TableName=this.tableName,this.client.query(e).promise().then(e=>{let t={data:e.Items||[]};return e.LastEvaluatedKey&&(t.next=Buffer.from(JSON.stringify(e.LastEvaluatedKey),"utf8").toString("base64")),t})}scanWithNext(e){return e.TableName=this.tableName,this.client.scan(e).promise().then(e=>{let t={data:e.Items||[]};return e.LastEvaluatedKey&&(t.next=Buffer.from(JSON.stringify(e.LastEvaluatedKey),"utf8").toString("base64")),t})}getItem(e,t){return e.TableName=this.tableName,this.client.get(e).promise().then(e=>e.Item||null)}batchWrite(e,t){return new Promise((n,s)=>{this._batchWrite(e,t).then(t=>{e.length>t.index?this.batchWrite(e,t.index).then(e=>{n(e)}):n(t.data)})})}_batchWrite(e,t){return new Promise((n,s)=>{let r=e.length>t+24?t+24:e.length,i=e.slice(t,r),o={RequestItems:{[this.tableName]:i}};this.client.batchWrite(o,(e,s)=>{e&&console.log("Any error? "+JSON.stringify(e,null,2)),n({index:t+24,data:s})})})}}},5:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));class s{constructor(e){this.userId=e.userId,this.extension=e.extension,this.username=e.username,this.transcribeVoicemail=e.transcribeVoicemail||!1,this.encryptVoicemail=e.encryptVoicemail||!1,this.deliveryOptions=e.deliveryOptions||{sms:{enabled:!1,phoneNumber:null},email:!1}}static create(e,t=null){return new s({userId:e,extension:t,deliveryOptions:{sms:{enabled:!1,phoneNumber:null},email:!1}})}}},6:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));const s={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Credentials":!0,"Strict-Transport-Security":"max-age=31536000; includeSubDomains","X-Frame-Options":"DENY"};const r={Response:function(e,t={},n=!1,r=null){let i={statusCode:e,body:JSON.stringify(t)};if(n&&(i.headers=s),r){let e=i.headers;e={...e,...r},i.headers=e}return i},Error:function e(t,n,r,i=!1){console.log(n,n instanceof e,n.toString());let o="",a="Error",u="",c="";n.hasOwnProperty("message")&&(o=n.message),n.hasOwnProperty("name")&&(a=n.name),n.hasOwnProperty("stack")&&(u=n.stack),n.hasOwnProperty("developerMessage")&&(c=n.developerMessage);let l={statusCode:t,body:JSON.stringify({errorMessage:r})};return i&&(l.headers=s),console.log("Error:",l),l}}},8:function(e,t){e.exports=require("https")},9:function(e,t){e.exports=require("awesome-phonenumber")}}));
//# sourceMappingURL=sync-vm-connect.js.map